## å¼•å…¥

æºç ï¼š4- 44åˆ†

### æµè§ˆå™¨å†…æ ¸

![image-20220320115622323](index.assets/image-20220320115622323.png) 

äº‹å®ä¸Š,æˆ‘ä»¬ç»å¸¸è¯´çš„æµè§ˆå™¨å†…æ ¸æŒ‡çš„æ˜¯æµè§ˆå™¨çš„æ’ç‰ˆå¼•æ“:

**æ’ç‰ˆå¼•æ“**( layout engine ) , ä¹Ÿç§°ä¸º**æµè§ˆå™¨å¼•æ“**( browser engine )ã€**é¡µé¢æ¸²æŸ“å¼•æ“**( rendering engine )æˆ–**æ ·ç‰ˆå¼•æ“**ã€‚

### æ¸²æŸ“å¼•æ“å·¥ä½œçš„è¿‡ç¨‹

![image-20220320120146609](index.assets/image-20220320120146609.png) 

### JavaScriptå¼•æ“

#### ä»¥webkitå†…æ ¸ä¸ºä¾‹

![image-20220320120411515](index.assets/image-20220320120411515.png) 

#### ä»¥v8å¼•æ“ä¸ºä¾‹

![image-20220320120356547](index.assets/image-20220320120356547.png)

#### v8å¼•æ“çš„åŸç†

![image-20220320120526042](index.assets/image-20220320120526042.png) 

### nodejsæ˜¯ä»€ä¹ˆ

> å®˜æ–¹ï¼šnode.jsæ˜¯ä¸€ä¸ª**åŸºäºV8JavaScriptå¼•æ“**çš„JavaScriptè¿è¡Œæ—¶ç¯å¢ƒ

node.jsä¸æ˜¯ä¸€é—¨è¯­è¨€ï¼Œä¸æ˜¯åº“ï¼Œä¸æ˜¯æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªJavaScriptè¿è¡Œæ—¶ç¯å¢ƒï¼Œ

ç®€å•ç‚¹å°±æ˜¯nodejså¯ä»¥**è§£æå’Œæ‰§è¡Œ**JavaScriptä»£ç ï¼Œä»¥å‰åªæœ‰æµè§ˆå™¨å¯ä»¥è§£æå’Œæ‰§è¡ŒJavaScriptä»£ç ï¼Œå°±æ˜¯è¯´ç°åœ¨JavaScriptå¯ä»¥å®Œå…¨æ‘†è„±æµè§ˆå™¨æ¥è¿è¡Œï¼Œä¸€åˆ‡éƒ½å½’åŠŸäºï¼šnodejs

**Node.jsé‡Œé¢æ²¡æœ‰BOM DOMï¼Œéœ€è¦å­¦ä¹ æœåŠ¡å™¨çº§åˆ«çš„æ“ä½œAPI**

### æµè§ˆå™¨å’ŒNode.jsæ¶æ„åŒºåˆ«

![image-20220320121505336](index.assets/image-20220320121505336.png) 

![image-20220320121519037](index.assets/image-20220320121519037.png) 

### nodejsåº”ç”¨åœºæ™¯

![image-20220320121701468](index.assets/image-20220320121701468.png) 

### nodeJSç‰ˆæœ¬é€‰æ‹©åŠå®‰è£…åŠå®‰è£…å¤šç‰ˆæœ¬ï¼ˆnvm å’Œ nï¼‰

å…¬å¸å¼€å‘å°±ä½¿ç”¨LTSç‰ˆæœ¬ï¼ˆç¨³å®šï¼‰ï¼Œå­¦ä¹ å°±ç”¨currentç‰ˆæœ¬ï¼ˆæ”¯æŒçš„jsæ–°ç‰¹æ€§æ›´å¤šï¼‰

å®‰è£…ï¼š

å®‰è£…è¿‡ç¨‹ä¸­ä¼š**é…ç½®ç¯å¢ƒå˜é‡**(è®©æˆ‘ä»¬**å¯ä»¥åœ¨å‘½ä»¤è¡Œä½¿ç”¨**) ; å¹¶ä¸”ä¼šå®‰è£…`npm(Node Package Manager)`å·¥å…·;

å®‰è£…å¤šç‰ˆæœ¬nodeï¼š

â€‹    éœ€è¦ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å·¥å…·`n(Interactively Manage Your Node.js Versionsäº¤äº’å¼ç®¡ç†ä½ çš„nodeç‰ˆæœ¬)`æˆ–`nvm(Node Version Manager)`ä¸¤ä¸ªéƒ½ä¸æ”¯æŒwindowsç³»ç»Ÿï¼Œnæ›´ç®€å•å¥½ç”¨

#### macç³»ç»Ÿä¸­[n](https://github.com/tj/n)çš„ä½¿ç”¨

ç›´æ¥ä½¿ç”¨npmå…¨å±€å®‰è£…`n`å·¥å…·

```shell
npm i n -g
```

å®‰è£… Node.js ç‰ˆæœ¬

åªéœ€æ‰§è¡Œ`n <version>`ä¸‹è½½å¹¶å®‰è£…ä¸€ä¸ªç‰ˆæœ¬çš„ Node.jsã€‚å¦‚æœ`<version>`å·²ç»ä¸‹è½½ï¼Œ`n`å°†ä»å…¶ç¼“å­˜ä¸­å®‰è£…ã€‚

```shell
# å®‰è£…10.16.0ç‰ˆæœ¬çš„node
n 10.16.0
# å®‰è£…æœ€æ–°ltsç‰ˆæœ¬çš„node
n lts
# å®‰è£…æœ€æ–°currentç‰ˆæœ¬çš„node
n latest

# åˆ é™¤8.0.0ç‰ˆæœ¬çš„node
n rm 8.0.0
```

> macç³»ç»Ÿå¦‚æœå®‰è£…éœ€è¦æƒé™ï¼Œåœ¨å‰é¢åŠ ä¸Š`sudo`
>
> ```shell
> sudo n lts
> ```

`n` æ‰§è¡Œnä»¥æŸ¥çœ‹æ‚¨ä¸‹è½½çš„ç‰ˆæœ¬ï¼Œå¹¶åˆ‡æ¢å®‰è£…é€‰å®šçš„ç‰ˆæœ¬ã€‚

```shell
$ n

  node/4.9.1
Î¿ node/8.11.3
  node/10.15.0

Use up/down arrow keys to select a version, return key to install, d to delete, q to quit
```

#### [nvm-windows](https://github.com/coreybutler/nvm-windows)çš„ä½¿ç”¨

nvmæ˜¯ä¸æ”¯æŒwindowsç³»ç»Ÿçš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰äººå¼€å‘å‡ºåœ¨windowsç³»ç»Ÿä¸­ä½¿ç”¨nvmåˆ‡æ¢nodeç‰ˆæœ¬çš„å·¥å…·`nvm-windows`

[githubä¸‹è½½](https://github.com/coreybutler/nvm-windows/releases)

![image-20220320135245373](index.assets/image-20220320135245373.png) 

ç›¸å…³å‘½ä»¤

```shell
# æŸ¥çœ‹nvmæ˜¯å¦å®‰è£…å®Œæˆ
nvm

# æŸ¥çœ‹å·²ç»å®‰è£…çš„nodeç‰ˆæœ¬åˆ—è¡¨
nvm list
# æŸ¥çœ‹å¯ç”¨çš„nodeç‰ˆæœ¬åˆ—è¡¨
nvm list available



# ç›´æ¥ä½¿ç”¨nvmå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„nodeå¼€ä¼šå¾ˆæ…¢ï¼Œå¯ä»¥æ·»åŠ æ·˜å®é•œåƒ
# è¿™é‡Œä½ éœ€è¦è®¾ç½®ä¸¤ä¸ªé•œåƒï¼Œnodeçš„é•œåƒå’Œnpmçš„é•œåƒï¼ˆå®‰è£…nodeä¼šé¡ºå¸¦å®‰è£…npmåŒ…ç®¡ç†å·¥å…·ï¼‰
# nodeé•œåƒ 
nvm node_mirror https://npm.taobao.org/mirrors/node/
# npmé•œåƒ
nvm npm_mirror https://npm.taobao.org/mirrors/npm/



# æ³¨æ„ï¼šå»ºè®®ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½è¿è¡Œç»ˆç«¯æ¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·Ÿmacç³»ç»Ÿä½¿ç”¨sudoé“ç†ç›¸åŒâ­

# å®‰è£…æœ€æ–°ltsç‰ˆæœ¬çš„node
nvm install lts
# å®‰è£…æœ€æ–°currentç‰ˆæœ¬çš„node
nvm install latest

# å¸è½½æŒ‡å®šç‰ˆæœ¬çš„node
nvm  uninstall <version>

# æŒ‡å®šç‰ˆæœ¬ï¼šè¿›è¡Œnodeç‰ˆæœ¬åˆ‡æ¢
nvm use <version>
```

```shell
Microsoft Windows [ç‰ˆæœ¬ 10.0.19044.1586]
(c) Microsoft Corporationã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚

C:\Windows\system32>nvm list

    16.13.1

C:\Windows\system32>nvm use 16.13.1
Now using node v16.13.1 (64-bit)

C:\Windows\system32>nvm list

  * 16.13.1 (Currently using 64-bit executable)

C:\Windows\system32>nvm install latest
Downloading node.js version 17.7.2 (64-bit)...
Extracting...
Complete


Installation complete. If you want to use this version, type

nvm use 17.7.2

C:\Windows\system32>nvm list

    17.7.2
  * 16.13.1 (Currently using 64-bit executable)

C:\Windows\system32>nvm use 17.7.2
Now using node v17.7.2 (64-bit)

C:\Windows\system32>nvm list

  * 17.7.2 (Currently using 64-bit executable)
    16.13.1

C:\Windows\system32>nvm use 16.13.1
Now using node v16.13.1 (64-bit)

C:\Windows\system32>nvm list

    17.7.2
  * 16.13.1 (Currently using 64-bit executable)
```

### REPLçš„ä½¿ç”¨ï¼šäº¤äº’å¼ç¼–ç¨‹ç¯å¢ƒ

REPLæ˜¯Read-Eval-print Loopçš„ç®€ç§°ï¼Œç¿»è¯‘ä¸º**è¯»å–-æ±‚å€¼-è¾“å‡º çš„å¾ªç¯**

æµè§ˆå™¨ä¸­consoleè¾“å‡ºç•Œé¢å¯ä»¥`è¾“å…¥jsä»£ç ç„¶åæ‰§è¡Œ`ï¼Œè¿™å°±æ˜¯REPL

nodeä¸­ä¹Ÿå¯ä»¥åƒæµè§ˆå™¨ä¸€æ ·ä½¿ç”¨replï¼šè¾“å…¥å‘½ä»¤ **node** å³å¯

![image-20220320132435459](index.assets/image-20220320132435459.png) 

## åŸºç¡€

### ç»™nodeä¼ é€’å‚æ•°

```shell
# æ‰§è¡Œnode.jsæ–‡ä»¶
node fileName
# ä¼ é€’å‚æ•°
node fileName aaa sasa

```

`process.argv`ä¸­è·å–ä¼ é€’çš„å‚æ•°

```shell
PS C:\Users\leopai\Desktop\leopai_web_notes\nodejs> node .\00process.js aaa sasa
[
  'D:\\Program Files\\nodejs\\node.exe',
  'C:\\Users\\leopai\\Desktop\\leopai_web_notes\\nodejs\\00process.js',
  'aaa',
  'sasa'
]
```

### nodeç¨‹åºè¾“å‡ºï¼ˆäº†è§£ï¼‰

```js
// console.log(process)
console.log(process.argv)

//æ¸…é™¤æ§åˆ¶å°
console.clear()

//è¾“å‡ºè­¦å‘Š
const names = 'Will Robinson'
console.warn(`Danger ${names}! Danger!`)

//è¾“å‡ºé”™è¯¯
console.error(new Error('Whoops, something bad happened'))

//è¾“å‡ºå‡½æ•°è°ƒç”¨æ ˆ
function aaa() {
  console.trace()
}
aaa()

```

```shell
# console.trace()æ–¹æ³•è·Ÿè¸ªaaaå‡½æ•°çš„æ‰§è¡Œæ ˆï¼Œå¯ä»¥æŸ¥çœ‹aaaå‡½æ•°åœ¨æŸæŸæ–‡ä»¶ä¸­è°ƒç”¨è¿‡
Trace
    at aaa (C:\Users\leopai\Desktop\leopai_web_notes\nodejs\00process.js:9:11)
    at Object.<anonymous> (C:\Users\leopai\Desktop\leopai_web_notes\nodejs\00process.js:11:1)
    at Module._compile (node:internal/modules/cjs/loader:1101:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1153:10)
    at Module.load (node:internal/modules/cjs/loader:981:32)
    at Function.Module._load (node:internal/modules/cjs/loader:822:12)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)
    at node:internal/main/run_main_module:17:47
    
Danger Will Robinson! Danger!

Error: Whoops, something bad happened
    at Object.<anonymous> (C:\Users\leopai\Desktop\leopai_web_notes\nodejs\00process.js:16:15)
    at Module._compile (node:internal/modules/cjs/loader:1101:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1153:10)
    at Module.load (node:internal/modules/cjs/loader:981:32)
    at Function.Module._load (node:internal/modules/cjs/loader:822:12)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)
    at node:internal/main/run_main_module:17:47
```

### ç‰¹æ®Šçš„å…¨å±€å¯¹è±¡

è¿™äº›å¯¹è±¡å…¶å®æ˜¯æ¨¡å—ä¸­çš„å˜é‡ï¼Œåªæ˜¯æ¯ä¸ªæ¨¡å—é‡Œé¢éƒ½æœ‰ï¼Œçœ‹èµ·æ¥æ˜¯å…¨å±€å˜é‡

åŒ…æ‹¬ï¼š`__dirnameã€__filenameã€exportsã€moduleã€require()`

`__dirname`å½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç»å¯¹è·¯å¾„

`__filename` å½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç»å¯¹è·¯å¾„æ–‡ä»¶å

```js
console.log(__dirname)//C:\Users\leopai\Desktop\leopai_web_notes\nodejs
console.log(__filename)//C:\Users\leopai\Desktop\leopai_web_notes\nodejs\process.js
```

åœ¨å‘½ä»¤è¡Œäº¤äº’(REPL)ä¸­ä¸å¯ä»¥ä½¿ç”¨

```shell
PS C:\Users\leopai\Desktop\leopai_web_notes\nodejs> node
Welcome to Node.js v16.13.1.      
Type ".help" for more information.
> __dirname
Uncaught ReferenceError: __dirname is not defined
> __filename
Uncaught ReferenceError: __filename is not defined
>
```

### [å¸¸è§å…¨å±€å˜é‡](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html)

- [Class: `Buffer`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#class-buffer)
- [`console`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#console)
- [`Event`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#event)
- [`exports`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#exports)
- [`global`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#global)
- [`module`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#module)
- [`process`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#process)
- [`require()`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#require)
- [`setImmediate(callback[, ...args\])`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#setimmediatecallback-args)
- [`setInterval(callback, delay[, ...args\])`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#setintervalcallback-delay-args)
- [`setTimeout(callback, delay[, ...args\])`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#settimeoutcallback-delay-args)
- [`URL`](https://nodejs.org/dist/latest-v16.x/docs/api/globals.html#url)

ä»¥ä¸Šä»…ä¸ºéƒ¨åˆ†

#### process

processæä¾›äº†Nodeè¿›ç¨‹ä¸­ç›¸å…³ä¿¡æ¯

æ¯”å¦‚`Nodeè¿è¡Œç¯å¢ƒã€å‚æ•°ä¿¡æ¯`

åœ¨é¡¹ç›®ä¸­ï¼Œå¯ä»¥å°†ä¸€äº›ç¯å¢ƒå˜é‡è¯»å–åˆ°`processçš„envä¸­`

#### console

#### è®¡æ—¶å™¨å¯¹è±¡

```js
//è®¡æ—¶å™¨ç›¸å…³å¯¹è±¡
setTimeout(() => {
  console.log('setTimeout')
}, 0)
setInterval(() => {
  console.log('setInterval')
}, 5000)
//setTimeoutæ—¶é—´è®¾ç½®ä¸º0å’ŒsetImmediateæ˜¯æœ‰åŒºåˆ«çš„
setImmediate(() => {
  console.log('setImmediate')
})
//ä¸‹ä¸€å¸§æ‰§è¡Œ
process.nextTick(() => {
  console.log('process.nextTick')
})

//è¿˜æœ‰ä¸ä¹‹å¯¹åº”çš„å–æ¶ˆå®šæ—¶å™¨çš„å¯¹è±¡
```

#### global

globalå¯¹è±¡ä¸æµè§ˆå™¨ä¸­çš„windowå¯¹è±¡ç±»ä¼¼ï¼Œå¦‚æœä¸€ä¸ªå±æ€§ä¸æ–¹ä¾¿è·å–ï¼Œå¯ä»¥ä½¿ç”¨`global.å±æ€§å`æ¥è·å–

åŒºåˆ«ï¼šæµè§ˆå™¨ä¸­å®šä¹‰å˜é‡ä¼šç›´æ¥æˆä¸ºwindowçš„å±æ€§ï¼Œnodeä¸­ä¸ä¼šæˆä¸ºglobalçš„å±æ€§ï¼Œå› ä¸ºæµè§ˆå™¨ä¸­æ²¡æœ‰æ¨¡å—çš„æ¦‚å¿µï¼Œæ‰€ä»¥ä¼šç›´æ¥å§å˜é‡æ”¾åˆ°windowå¯¹è±¡ä¸­ï¼Œä½†æ˜¯nodeä¸­æ¯ä¸€ä¸ªjsæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ï¼Œå®šä¹‰çš„å˜é‡åªå±äºè¿™ä¸ªæ¨¡å—ä½†æ˜¯ä¸å±äºå…¨å±€

```js
const name = 'aaaaaa'
console.log(name) //aaaaaa
console.log(global.name) //undefined
```

> æ§åˆ¶å°è¾“å‡ºæ¥æŸ¥çœ‹globalå…¨å±€å¯¹è±¡çš„å±æ€§æ˜¯ä¸å…¨çš„ï¼Œå¯ä»¥åœ¨nodeçš„repläº¤äº’ä¸­æ•²**`global. `å†æŒ‰ä¸¤æ¬¡tabé”®æŸ¥çœ‹** 
>
> ```shell
> PS C:\Users\leopai\Desktop\leopai_web_notes\nodejs> node
> Welcome to Node.js v16.13.1.
> Type ".help" for more information.
> > global.
> global.__proto__             global.hasOwnProperty        global.isPrototypeOf         global.propertyIsEnumerable  global.toLocaleString
> global.toString              global.valueOf
> 
> global.constructor
> 
> global.AbortController       global.AbortSignal           global.AggregateError        global.Array                 global.ArrayBuffer
> global.Atomics               global.BigInt                global.BigInt64Array         global.BigUint64Array        global.Boolean
> global.Buffer                global.DataView              global.Date                  global.Error                 global.EvalError
> global.Event                 global.EventTarget           global.FinalizationRegistry  global.Float32Array          global.Float64Array
> global.Function              global.Infinity              global.Int16Array            global.Int32Array            global.Int8Array
> global.Intl                  global.JSON                  global.Map                   global.Math                  global.MessageChannel
> global.MessageEvent          global.MessagePort           global.NaN                   global.Number                global.Object
> global.Promise               global.Proxy                 global.RangeError            global.ReferenceError        global.Reflect
> global.RegExp                global.Set                   global.SharedArrayBuffer     global.String                global.Symbol
> global.SyntaxError           global.TextDecoder           global.TextEncoder           global.TypeError             global.URIError
> global.URL                   global.URLSearchParams       global.Uint16Array           global.Uint32Array           global.Uint8Array
> global.Uint8ClampedArray     global.WeakMap               global.WeakRef               global.WeakSet               global.WebAssembly
> global._                     global._error                global.assert                global.async_hooks           global.atob
> global.btoa                  global.buffer                global.child_process         global.clearImmediate        global.clearInterval
> global.clearTimeout          global.cluster               global.console               global.constants             global.crypto
> global.decodeURI             global.decodeURIComponent    global.dgram                 global.diagnostics_channel   global.dns
> global.domain                global.encodeURI             global.encodeURIComponent    global.escape                global.eval
> global.events                global.fs                    global.global                global.globalThis            global.http
> global.http2                 global.https                 global.inspector             global.isFinite              global.isNaN
> global.module                global.net                   global.os                    global.parseFloat            global.parseInt
> global.path                  global.perf_hooks            global.performance           global.process               global.punycode
> global.querystring           global.queueMicrotask        global.readline              global.repl                  global.require
> global.setImmediate          global.setInterval           global.setTimeout            global.stream                global.string_decoder
> global.sys                   global.timers                global.tls                   global.trace_events          global.tty
> global.undefined             global.unescape              global.url                   global.util                  global.v8
> global.vm                    global.wasi                  global.worker_threads        global.zlib
> ```

### JavaScriptæ¨¡å—åŒ–

![image-20220320204600197](index.assets/image-20220320204600197.png) 

nodeä¸­çš„jsæœ‰é‡è¦çš„æ¦‚å¿µï¼š`æ¨¡å—ç³»ç»Ÿ`

`require`åŠ è½½æ¨¡å—     `exports`å¯¼å‡ºæ¨¡å—

#### commonjså’Œnode

![image-20220320204835997](index.assets/image-20220320204835997.png) 

```js
//æ²¡æœ‰æ¨¡å—åŒ–çš„æ—¶å€™å®ç°æ¨¡å—åŒ–å¯ä»¥ä½¿ç”¨IIFE
const moduleAAA = (function () {
  var name = 'wang'
  var age = 18
  return {
    name: name,
    age: age,
  }
})()
//è¿™æ ·æŠŠæ–‡ä»¶åµŒå…¥åˆ°htmlæ–‡ä»¶å½“ä¸­ï¼Œå…¶ä»–çš„jsæ–‡ä»¶å°±å¯ä»¥ä½¿ç”¨moduleAAA.nameæ¥ä½¿ç”¨äº†
```

#### exportså’Œmodule.exports

æ¯ä¸ªæ¨¡å—é‡Œé¢åŸæœ¬éƒ½æœ‰ä¸€ä¸ª`exportsç©ºå¯¹è±¡`ï¼Œé€šè¿‡æ·»åŠ ï¼ˆå¯¼å‡ºï¼‰å±æ€§ä¾›åˆ«çš„æ¨¡å—ä½¿ç”¨

`moo = require('./å¯¼å‡ºçš„æ–‡ä»¶å')`å¯¹è±¡æ˜¯exportså¯¹è±¡çš„æµ…æ‹·è´ï¼ˆæµ…æ‹·è´å°±æ˜¯å¼•ç”¨èµ‹å€¼ï¼‰

![image-20220320205303391](index.assets/image-20220320205303391.png) 

> `exportsæ˜¯commonjsé‡Œé¢è¦æ±‚exportsä½œä¸ºå¯¼å‡ºï¼Œè€Œnodeä¸­å¢åŠ äº†module.exports`
>
> æ¯ä¸ªæ¨¡å—ä¸­éƒ½æœ‰ä¸€ä¸ªmoduleå¯¹è±¡ï¼ŒçœŸæ­£å¯¼å‡ºçš„æ˜¯moduleå¯¹è±¡é‡Œé¢çš„exports

```js
// module.exports === exports      nodeå†…éƒ¨è¯­å¥ï¼ˆåœ¨é¡¶å±‚ï¼‰
console.log(module.exports === exports) //true

exports.aa = 'aa'
exports.fn = function (x, y) {
  return x + y
}

/*
ä¸è¦å†™ exports = {}è¿™ç§è¯­å¥ï¼Œä¸ç®¡ç”¨ï¼Œå› ä¸ºcommonjsæ¨¡å—åŒ–å†…éƒ¨é»˜è®¤è¯­å¥æ˜¯åœ¨æ–‡ä»¶æœ€åº•éƒ¨æœ€ç»ˆå¯¼å‡ºçš„æ˜¯ ï¼šreturn module.exportsï¼Œå¦‚æœé‚£æ ·å†™æ˜¯å°†exportsæŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¼å‡ºçš„ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬å¯¼å‡ºå¤šä¸ªæ˜¯ä½¿ç”¨
module.exports={...}

è®°ä½æœ€ç»ˆå¯¼å‡ºçš„æ˜¯module.exportså³å¯â­ï¼Œå¦‚æœmodule.exportsé‡æ–°èµ‹å€¼ï¼ˆæŒ‡å‘ä¸€ä¸ªæ–°å¯¹è±¡ï¼‰ï¼Œåˆ™exportsæ–¹æ³•å¯¼å‡ºå°±æ— æ•ˆ
ä¸€èˆ¬ä¸ä¼šæ··åˆä½¿ç”¨
*/
//å¯¼å‡ºå¤šä¸ªæ¥å£æˆå‘˜
exports.xx1 = xxx
exports.xx2 = xxx
exports.xx3 = xxx
//æˆ–
module.exports = { xx1, xx2, xx3 }

//å¯¼å‡ºå•ä¸ªæ¥å£æˆå‘˜
module.exports.xx = xxx

/**
 * å¯¼å…¥ï¼šconst moo = require(â€˜./å¯¼å‡ºçš„æ–‡ä»¶åâ€™)
 * require(â€˜./å¯¼å‡ºçš„æ–‡ä»¶åâ€™) è¿”å›çš„å°±æ˜¯å¯¼å‡ºçš„é‚£ä¸ªå¯¹è±¡
 * æ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨moo.xxxæ¥ä½¿ç”¨å¯¼å‡ºçš„å±æ€§
 */
```

#### requireç»†èŠ‚

requireæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯¼å…¥æ ¼å¼ï¼šrequireï¼ˆXï¼‰

* 1ã€Xæ˜¯ä¸€ä¸ª`æ ¸å¿ƒæ¨¡å—`ï¼Œæ¯”å¦‚pathã€httpä¼šç›´æ¥è¿”å›æ ¸å¿ƒæ¨¡å—ï¼Œå¹¶åœæ­¢æŸ¥æ‰¾

* 2ã€Xæ˜¯ä»¥**./**æˆ– **../**æˆ– **/**ï¼ˆæ ¹ç›®å½•ï¼‰å¼€å¤´çš„     //è‡ªå®šä¹‰æ¨¡å—ï¼Œå‰ä¸¤ä¸ªæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä»è‡ªèº«æ–‡ä»¶çš„ç›¸å¯¹æ–‡ä»¶æŸ¥æ‰¾ï¼Œåé¢ä¸€ä¸ªæ˜¯ç»å¯¹è·¯å¾„ï¼Œä¼šä»æ•´ä¸ªè®¡ç®—æœºæŸ¥æ‰¾

  * å°†Xä½œä¸ºä¸€ä¸ªæ–‡ä»¶åœ¨å¯¹åº”ç›®å½•ä¸‹æŸ¥æ‰¾
    * æ–‡ä»¶æœ‰åç¼€åï¼Œä¼šæ ¹æ®åç¼€åæ ¼å¼æ¥æŸ¥æ‰¾
    * æ²¡æœ‰åç¼€åï¼Œä¼šæŒ‰ç…§`æ–‡ä»¶X > X.js > X.json > X.node`è¿™ä¸ªé¡ºåºæ¥æŸ¥æ‰¾
  * æ²¡æœ‰æ‰¾åˆ°å¯¹åº”æ–‡ä»¶ï¼Œå°†Xä½œä¸ºä¸€ä¸ªç›®å½•æ¥æŸ¥æ‰¾
    * æŸ¥æ‰¾ç›®å½•ä¸‹çš„`indexæ–‡ä»¶`ï¼ŒæŒ‰ç…§`X/index.js > X/index.json > X/index.node`è¿™ä¸ªé¡ºåºæ¥æŸ¥æ‰¾
  * æ²¡æœ‰æ‰¾åˆ°å°±æŠ¥é”™ï¼šNot Found

* 3ã€ç›´æ¥æ˜¯ä¸€ä¸ªXï¼ˆæ²¡æœ‰è·¯å¾„ï¼‰ï¼Œå¹¶ä¸”Xä¸æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—

  * ä¼šå…ˆçœ‹Xæ˜¯ä¸æ˜¯æ ¸å¿ƒæ¨¡å—ï¼Œå¦‚æœä¸æ˜¯ï¼Œ`ä¼šä»å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸‹çš„node_modulesæ–‡ä»¶å¤¹å¼€å§‹æŸ¥æ‰¾ï¼Œåœ¨é€å±‚å¾€ä¸ŠæŸ¥æ‰¾ï¼Œç›´åˆ°æ ¹ç›®å½•ä¸‹çš„node_modulesæ–‡ä»¶å¤¹ï¼Œæ²¡æœ‰æ‰¾åˆ°åˆ™æŠ¥é”™ï¼šNot Found`

    > nodeä¸­æ¯ä¸ªjsæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªmoduleå¯¹è±¡ï¼Œå½“å‰åœ¨`commonjs/require.js`ä¸­å†™äº†`require('X')`ï¼Œä¼šéå†pathsæ•°ç»„ï¼Œé€å±‚å¾€ä¸ŠæŸ¥æ‰¾æ¨¡å—X

    ```shell
    console.log(module)ğŸ‘‡ğŸ‘‡
    
    Module {
      id: '.',
      path: 'C:\\Users\\leopai\\Desktop\\leopai_web_notes\\nodejs\\commonjs',
      exports: {},
      filename: 'C:\\Users\\leopai\\Desktop\\leopai_web_notes\\nodejs\\commonjs\\require.js',
      loaded: false,# æ¨¡å—æ˜¯å¦è¢«åŠ è½½äº†ï¼Œè¢«åŠ è½½è¿‡ï¼Œå˜æˆtrueï¼Œä¹‹åå†æ¬¡require('è¯¥æ¨¡å—')ä¼šç›´æ¥ä»ç¼“å­˜ä¸­å–
      children: [],
      paths: [
        'C:\\Users\\leopai\\Desktop\\leopai_web_notes\\nodejs\\commonjs\\node_modules',
        'C:\\Users\\leopai\\Desktop\\leopai_web_notes\\nodejs\\node_modules',
        'C:\\Users\\leopai\\Desktop\\leopai_web_notes\\node_modules',
        'C:\\Users\\leopai\\Desktop\\node_modules',
        'C:\\Users\\leopai\\node_modules',
        'C:\\Users\\node_modules',
        'C:\\node_modules'
      ]
    }
    ```

#### commonjsè§„èŒƒç¼ºç‚¹

![image-20220321201928895](index.assets/image-20220321201928895.png) 

#### commonjsæ¨¡å—åŠ è½½è¿‡ç¨‹

commonjsåŠ è½½è¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œes moduleåŠ è½½æ˜¯å¼‚æ­¥çš„

* ç»“è®ºä¸€ï¼šæ¨¡å—åœ¨è¢«åŠ è½½ç¬¬ä¸€æ¬¡æ—¶ï¼Œæ¨¡å—ä¸­çš„ä»£ç ä¼šè¢«è¿è¡Œä¸€æ¬¡

```js
require('./index') //å…ˆè¿è¡Œé‡Œé¢çš„ä»£ç 

console.log(module) //åæ‰§è¡Œ
```

* ç»“è®ºäºŒï¼šæ¨¡å—åœ¨è¢«å¼•å…¥å¤šæ¬¡æ—¶ï¼Œä¼šç¼“å­˜ï¼Œæœ€ç»ˆåªåŠ è½½ä¸€æ¬¡ï¼Œä¼˜å…ˆä»ç¼“å­˜åŠ è½½

`module.loaded = true`	

![image-20220321204906303](index.assets/image-20220321204906303.png) 

* ç»“è®ºä¸‰ï¼šå¾ªç¯å¼•å…¥ï¼Œé‚£ä¹ˆåŠ è½½é¡ºåºæ˜¯ä»€ä¹ˆ

![image-20220321205918911](index.assets/image-20220321205918911.png) 

æ­¤æ•°æ®ç»“æ„ä¸º`å›¾ç»“æ„`ï¼Œæ‰§è¡Œmain.jsï¼š

* å…ˆæ‰§è¡Œ`require('./aaa')`,åˆ™`main > aaa > ccc > ddd > eee > bbb`
* å…ˆæ‰§è¡Œ`require('./bbb')`,åˆ™`main > bbb > ccc > ddd > eee > aaa`

è·Ÿ`æ¨¡å—å¼•å…¥é¡ºåº`å’Œ`æ¨¡å—æ˜¯å¦å·²è¢«åŠ è½½`æœ‰å…³ï¼Œå¹¶éæ·±åº¦ä¼˜å…ˆç®—æ³•

### ES Module

ES Moduleé‡‡ç”¨exportå’Œimportå…³é”®å­—å®ç°æ¨¡å—åŒ–

ES Moduleé‡‡ç”¨äº†`ä¸¥æ ¼æ¨¡å¼ use strict`

ES Moduleé‡‡ç”¨ç¼–è¯‘æœŸçš„é™æ€åˆ†æï¼Œå¹¶ä¸”ä¹ŸåŠ å…¥çœ‹äº†åŠ¨æ€å¼•ç”¨çš„æ–¹å¼ 

#### æ¨¡å—åŒ–å¯¼å‡ºå¯¼å…¥æ–¹å¼

å¯¼å‡ºï¼š

 ```js
 //æ–¹å¼ä¸€
 export const name = 'yang'
 export const age = '22'
 export function outPut() {
   console.log('hahaha')
 }
 //æ–¹å¼äºŒ  æ³¨æ„ï¼šexportåé¢çš„`èŠ±æ‹¬å·ä¸æ˜¯å¯¹è±¡`â­
 export { name, age, outPut }
 
 //æ–¹å¼ä¸‰  èµ·åˆ«å
 export { name as Aname, age as Aage, outPut as AoutPut }
 
 //æ–¹å¼å››: å¯ä»¥è·Ÿä¸Šé¢åŒæ—¶å­˜åœ¨ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªexport defaultâ­
 //é»˜è®¤å¯¼å‡ºï¼Œå¯¼å…¥æ—¶å¯ä»¥è‡ªå®šä¹‰åå­—æ¥ä½¿ç”¨å®ƒ
 export default function () {
   console.log(111)
 }
 ```

å¯¼å…¥ï¼š

```js
//æ–¹å¼ä¸€
import { name, age, outPut } from './aaa.js'

//æ–¹å¼äºŒ  èµ·åˆ«åï¼š å¯¼å‡ºæ—¶èµ·åˆ«åè¿™é‡Œè¿˜å¯ä»¥èµ·ï¼Œ
import {
  Aname as AAAname,
  Aage as AAAage,
  AoutPut as AAAoutPut,
} from './aaa.js'

//æ–¹å¼ä¸‰  * ç»Ÿä¸€å¯¼å…¥æ”¾å…¥å¯¹è±¡ä¸­
import * as obj from './aaa.js'
```

å¯¼å…¥å¹¶ç›´æ¥å¯¼å‡º

å½“è‡ªå·±å°è£…æˆ–å¼€å‘åŠŸèƒ½åº“æ—¶ï¼Œé€šå¸¸å°†æš´éœ²çš„æ¥å£æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™æ ·æ–¹ä¾¿ç»Ÿä¸€æ¥å£è§„èŒƒï¼Œä¹Ÿæ–¹ä¾¿é˜…è¯»

```js
export { Aname, Aage, AoutPut } from './aaa.js'
```

#### htmlæ–‡ä»¶ä¸­ä½¿ç”¨æ¨¡å—åŒ–

![image-20220321220333487](index.assets/image-20220321220333487.png) 

åœ¨HTMLæ–‡ä»¶ä¸­ä½¿ç”¨æ¨¡å—åŒ–è¦åœ¨`script`æ ‡ç­¾ä¸­åŠ ä¸Š`type="module"`ï¼Œå¹¶ä¸”å¼€å¯ä¸€ä¸ª`æœåŠ¡`æ¥è¿è¡Œè¿™ä¸ªhtmlæ–‡ä»¶ï¼Œå¦åˆ™æ— æ•ˆï¼ˆè·¨åŸŸé—®é¢˜ï¼‰

#### å‡½æ•° import()

é€šè¿‡importåŠ è½½ä¸€ä¸ªæ¨¡å—`ä¸å¯ä»¥æ”¾åˆ°é€»è¾‘ä»£ç ä¸­`ï¼Œå¯ä»¥ä½¿ç”¨**import()å‡½æ•°**

> ä¸èƒ½æŠŠimportå…³é”®å­—æ”¾åœ¨è¿è¡Œä»£ç å½“ä¸­ï¼Œå› ä¸ºES Moduleåœ¨è¢«js**è§£æçš„æ—¶å€™ï¼Œå°±å¿…é¡»çŸ¥é“å®ƒçš„ä¾èµ–å…³ç³»**ï¼Œç”±äºè¿™ä¸ªæ—¶å€™jsæ–‡ä»¶`æ²¡æœ‰ä»»ä½•çš„è¿è¡Œ`ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œç±»ä¼¼äºifåˆ¤æ–­ä¸­ä»£ç çš„æ‰§è¡Œæƒ…å†µï¼Œï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µæˆ‘ä»¬å¸Œæœ›`åŠ¨æ€`çš„æ¥åŠ è½½æŸä¸€ä¸ªæ¨¡å—ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨import()å‡½æ•°

jså¼•æ“è§£æå’Œæ‰§è¡Œï¼š`parsingï¼ˆè§£æï¼‰=>AST => å­—èŠ‚ç =>äºŒè¿›åˆ¶=>ä»£ç æ‰§è¡Œ`

importå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª`promise`ï¼Œåé¢æ¥ä¸Šthenæ‹¿åˆ°å¯¼å…¥çš„æ¥å£æ•°æ®

```js
const mark = false
if(mark){
    // console.log(111);
}else{
    import('./index.js').then(res=>{
        console.log(res);//./index.jsæ–‡ä»¶ä¸­æ‰€æœ‰å¯¼å‡ºçš„æ¨¡å—
    })
}
```

**requireï¼ˆ''ï¼‰å¯ä»¥åœ¨ifè¯­å¥ä¸­ä½¿ç”¨æ˜¯å› ä¸ºrequireæœ¬èº«å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ˜¯åœ¨`æ‰§è¡Œï¼ˆè¿è¡Œï¼‰`é˜¶æ®µ**

#### es moduleæ¨¡å—åŠ è½½è¿‡ç¨‹

![image-20220321222725676](index.assets/image-20220321222725676.png) 

ä½¿ç”¨exportå¯¼å‡ºname=â€˜aaaâ€™ï¼Œ1ç§’é’Ÿä¹‹åæŠŠnameèµ‹å€¼ä¸ºâ€bbbâ€ï¼Œåˆ™2ç§’é’Ÿä¹‹åimportå¾—åˆ°çš„nameæ˜¯bbb    //exportåé¢å¯¼å‡ºçš„èŠ±æ‹¬å·ä¸æ˜¯å¯¹è±¡ï¼Œä¸commonjsä¸ä¸€æ ·

```js
let name = 'aaa'
setTimeout(() => {
    name = 'dddddd'
}, 1000)
//es modules
export {
    name //è¿™é‡Œä¸¤ç§’é’Ÿä¹‹åæ”¹æˆäº†ddddddï¼Œé‚£2ç§’é’Ÿåå¦ä¸€ä¸ªæ¨¡å—å¼•ç”¨çš„nameå€¼ä¹Ÿä¼šå˜æˆdddddd
}
//commonjs
moudle.exports = {
    name //è¿™é‡Œå¯¼å‡ºçš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å¯¹è±¡é‡Œé¢çš„å±æ€§å«nameï¼Œç›¸å½“äºname:name,åªæ˜¯æŠŠå˜é‡nameæ”¹æ‰äº†ï¼Œè€Œä¸æ˜¯æ”¹æ‰äº†nameå±æ€§ï¼Œæ‰€ä»¥2ç§’ä¸­åè¿˜æ˜¯aaa
}

```

```js
let name = "aaa";

//æ¨¡å—ä¸€å¯¼å‡ºname
export {
  name,
};
//æ¨¡å—äºŒå¼•å…¥name
// import {name} from ...

//å¦‚æœnameæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¸å…è®¸ä¿®æ”¹ï¼Œè¯­æ³•é”™è¯¯
// å¦‚æœnameæ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œå¯ä»¥ä¿®æ”¹é‡Œé¢çš„å±æ€§ï¼Œå¹¶ä¸”ä¿®æ”¹è¿‡åï¼Œæ¨¡å—ä¸€ä¸­æ‹¿åˆ°çš„æ˜¯æ¨¡å—äºŒä¿®æ”¹åçš„æ•°æ®ï¼ˆæŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼‰â­
```

#### Nodeå¯¹ES Moduleçš„æ”¯æŒ

![image-20220321224059011](index.assets/image-20220321224059011.png) 

### Commonjså’ŒES Moduleäº¤äº’

> nodeä¸­çš„æ¨¡å—åŒ–ä½¿ç”¨çš„æ˜¯commonjsï¼Œå¦‚æœåœ¨nodeä¸­ä½¿ç”¨es moduleï¼Œé‚£ä¹ˆæ–‡ä»¶æ‰©å±•åè¦ä½¿ç”¨ **.mjs**æ‰èƒ½å¤Ÿæ­£ç¡®è¿è¡Œ

ä¸æ˜¯ç»å¯¹çš„ï¼Œçœ‹å¹³å°

![image-20220321224623015](index.assets/image-20220321224623015.png) 

### å¸¸è§å†…ç½®æ¨¡å—pathã€fsã€events

#### path

![image-20220322215058610](index.assets/image-20220322215058610.png)

æ–‡ä»¶è·¯å¾„æ‹¼æ¥ï¼š

â€‹	**path.resolve('è·¯å¾„'ï¼Œ'æ–‡ä»¶å')**

â€‹	**path.join('è·¯å¾„'ï¼Œ'æ–‡ä»¶å')**

è·å–æ–‡ä»¶è·¯å¾„ä¿¡æ¯ï¼š

â€‹    **path.dirname('æ–‡ä»¶å®Œæ•´è·¯å¾„')**

â€‹	**path.basename('æ–‡ä»¶å®Œæ•´è·¯å¾„')**

â€‹	**path.extname('æ–‡ä»¶å®Œæ•´è·¯å¾„')**  

```js
const path = require('path')

const basePath = '../fea1/node'
const fileName = 'aaa.js'
// 1ã€è·¯å¾„çš„æ‹¼æ¥path.resolve()å’Œpath.join()    //resolveç”¨çš„å¤š
//path.resolve()ä¼šåˆ¤æ–­è·¯å¾„æ‹¼æ¥çš„å­—ç¬¦ä¸²ä¸­æ˜¯å¦æœ‰/æˆ–./æˆ–../å¼€å¤´çš„è·¯å¾„ï¼Œè·å–çš„æ˜¯è¯¥è·¯å¾„æ‰€åœ¨çš„ç»å¯¹è·¯å¾„ï¼Œæ›´åŠ çµæ´»ï¼Œä½†æ˜¯path.join()ä¼šç›´æ¥æ‹¼æ¥
const filePath1 = path.resolve(basePath, fileName)
console.log(filePath1) //D:\node\nodeç»ƒä¹ \fea1\node\aaa.js
const filePath2 = path.join(basePath, fileName)
console.log(filePath2) //..\fea1\node\aaa.js

//1
const basePath = '../fea1/node'
const fileName = '/aaa.js' // /å¼€å¤´
const filePath1 = path.resolve(basePath, fileName)//D:\aaa.js

//2
const basePath = '../fea1/node'
const fileName = './aaa.js' // ./å¼€å¤´
const filePath1 = path.resolve(basePath, fileName)//D:\node\nodeç»ƒä¹ \fea1\node\aaa.js

//3
const basePath = '../fea1/node'
const fileName = '../aaa.js' // ../å¼€å¤´,ä¼šæ‰¾åˆ°ä¸Šä¸€å±‚
const filePath1 = path.resolve(basePath, fileName)//D:\node\nodeç»ƒä¹ \fea1\aaa.js


//2ã€è·å–è·¯å¾„ç›¸å…³ä¿¡æ¯
const filePath3 = 'node/aaa/haha.txt'
console.log(path.dirname(filePath3)) //è·å–è·¯å¾„å‰é¢çš„æ–‡ä»¶å¤¹ä¿¡æ¯ node/aaa
console.log(path.basename(filePath3)) //è·å–åé¢çš„æ–‡ä»¶ä¿¡æ¯ haha.txt
console.log(path.extname(filePath3)) //è·å–æ–‡ä»¶æ‰©å±•åä¿¡æ¯ .txt
```

#### fs

`__dirname` æ€»æ˜¯æŒ‡å‘è¢«æ‰§è¡Œ js æ–‡ä»¶çš„`ç»å¯¹è·¯å¾„`ï¼Œæ‰€ä»¥å½“ä½ åœ¨ `/d1/d2/myscript.js` æ–‡ä»¶ä¸­å†™äº† `__dirname`ï¼Œ å®ƒçš„å€¼å°±æ˜¯ `/d1/d2` ã€‚

![image-20220322220325874](index.assets/image-20220322220325874.png) 

æ–‡ä»¶ç³»ç»Ÿçš„APIå¤§å¤šæä¾›ä¸‰ç§æ“ä½œæ–¹å¼

![image-20220322220524943](index.assets/image-20220322220524943.png) 

* è·å–æ–‡ä»¶ä¿¡æ¯

  ```js
  const fs = require('fs')
  //æ¡ˆä¾‹ï¼šè¯»å–æ–‡ä»¶ä¿¡æ¯
  const filePath = './fsæ–‡ä»¶è¯»å–.txt' //æ–‡ä»¶è·¯å¾„
  
  //æ–¹å¼ä¸€ï¼šåŒæ­¥æ“ä½œ
  const info = fs.statSync(filePath)
  console.log('info',info)
  console.log('é˜»å¡')
  
  
  //æ–¹å¼äºŒï¼šå¼‚æ­¥æ“ä½œ
  fs.stat(filePath, (err, stats) => {
    if (err) {
      console.log(err)
      return
    }
    console.log('stats',stats)
  })
  console.log('å¼‚æ­¥ï¼Œä¸ä¼šè¢«é˜»å¡')
  
  
  //æ–¹å¼3ï¼špeomiseæ“ä½œ
  fs.promises
    .stat(filePath)
    .then((data) => {
      console.log(data)
    })
    .catch((err) => {
      console.log(err)
    })
  console.log('promiseå¼‚æ­¥æ“ä½œï¼Œä¸ä¼šé˜»å¡')
  ```

  æ–‡ä»¶æè¿°ç¬¦fdâ­

  ![image-20220322221800180](index.assets/image-20220322221800180.png) 

  ```js
  // æ–¹å¼å››ï¼šå…ˆè·å–æ–‡ä»¶æè¿°ç¬¦ï¼Œå†æ ¹æ®æ–‡ä»¶æè¿°ç¬¦æ¥æ“ä½œæŸä¸€ä¸ªæ–‡ä»¶
  fs.open(filePath, (err, fd) => {
    if (err) return
    console.log(fd) //æ–‡ä»¶æè¿°ç¬¦
    fs.fstat(fd, (err, info) => {
      console.log(info) //æ–‡ä»¶ä¿¡æ¯
    })
  }) 
  ```

* æ–‡ä»¶çš„è¯»å†™ 

  ```js
  const fs = require('fs')
  
  //æ–‡ä»¶å†™å…¥
  const content = 'ä½ å¥½å•Šåˆ©ç›Šå’Œ'
  fs.writeFile('./fsæ–‡ä»¶è¯»å–.txt', content, { flag: 'a' }, (err) => {
    //ç¬¬ä¸‰ä¸ªå‚æ•°å¯é€‰ï¼Œflagé€‰é¡¹
    console.log(err) //ä¸ºnullå°±å†™å…¥æˆåŠŸ
  })
  
  // æ–‡ä»¶è¯»å–
  fs.readFile('./fsæ–‡ä»¶è¯»å–.txt', { encoding: 'utf-8' }, (err, data) => {
    //å¯é€‰å‚æ•°encodingæŒ‡å®šå­—ç¬¦ç¼–ç ï¼Œé»˜è®¤utf-8
    console.log(data)
    console.log('æ–‡ä»¶è¯»å–æˆåŠŸ')
  })
  ```

  å¸¸è§flagé€‰é¡¹

  ![image-20220322222448800](index.assets/image-20220322222448800.png) 

  [å­—ç¬¦ç¼–ç è¯¦è§£](https://www.jianshu.com/p/899e749be47c)

* æ–‡ä»¶å¤¹æ“ä½œ

  ```js
  const fs = require('fs')
  const path = require('path')
  
  
  //1.åˆ›å»ºæ–‡ä»¶å¤¹
  const dirName = './åˆ›å»ºçš„æ–‡ä»¶å¤¹'
  //å…ˆåˆ¤æ–­è¿™ä¸ªæ–‡ä»¶å¤¹å­˜ä¸å­˜åœ¨
  if (!fs.existsSync(dirName)) { //fs.existsSync()åˆ¤æ–­æ–‡ä»¶å¤¹å­˜ä¸å­˜åœ¨ï¼ˆåŒæ­¥ï¼‰
      fs.mkdir(dirName, err => { //fs.mkdir()åˆ›å»ºæ–‡ä»¶å¤¹
          console.log('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
      })
  }
  
  //2.è¯»å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶
  //withFileTypeså¯é€‰å‚æ•°ï¼Œé»˜è®¤ä¸ºfalseï¼Œä½¿è¯»å–çš„æ–‡ä»¶åæˆ–æ–‡ä»¶å¤¹åä¸ºå¯¹è±¡æ–¹å¼å­˜åœ¨ï¼Œä»¥å¯¹è±¡æ–¹å¼å­˜åœ¨å°±å¯ä»¥è°ƒç”¨isFile()å’ŒisDirectory()
  fs.readdir(dirName, { withFileTypes: true }, (err, files) => {
      console.log(files);
  })
  
  //è¯»å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å¤¹ä¸­è¿˜æœ‰æ–‡ä»¶å¤¹ï¼Œä¹Ÿéƒ½è¯»å–
  //fs.readdirSync() åŒæ­¥è¯»å–
  function getFiles(dirName) {
      fs.readdir(dirName, { withFileTypes: true }, (err, files) => {
          files.forEach(item => {
              if (item.isDirectory()) { //item.isDirectory()æ˜¯æ–‡ä»¶å¤¹è¿”å›true
                  const filePath = path.resolve(dirName, item.name)
                  getFiles(filePath) //å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œé€’å½’è°ƒç”¨
              } else {
                  console.log(item.name)
              }
          })
      })
  }
  getFiles(dirName)
  
  // 3.é‡å‘½å
  fs.rename('./åˆ›å»ºçš„æ–‡ä»¶å¤¹','./æ–°åå­—',(err,info)=>{
      if(err) return
      console.log(info);
      console.log(info.isDirectory());
      console.log(info.isFile());
  })
  ```

#### events

```js
const EventEmitter = require('events')
//åˆ›å»ºå‘å°„å™¨
const emitter = new EventEmitter()
//ç›‘å¬å‘å‡ºçš„clickäº‹ä»¶
// onæ˜¯addListenerçš„alias
emitter.on('click', (arg1, arg2) => {
    console.log("ç›‘å¬1", arg1, arg2);
})
const listener = arg1 => {
    console.log("ç›‘å¬2", arg1);
}
emitter.on('click', listener)
setTimeout(() => {
    emitter.off('click', listener) //å–æ¶ˆå¯¹æŒ‡å®šäº‹ä»¶çš„ç›‘å¬
    //å‘å‡ºclickäº‹ä»¶
    emitter.emit('click', 'ä¿¡æ¯1', 'ä¿¡æ¯2')
}, 2000)
```

### [Buffer](https://nodejs.org/dist/latest-v16.x/docs/api/buffer.html)

#### æ•°æ®çš„äºŒè¿›åˆ¶

![image-20220330135841620](index.assets/image-20220330135841620.png) 

#### Bufferå’ŒäºŒè¿›åˆ¶

![image-20220330140339090](index.assets/image-20220330140339090.png) 

#### Bufferå’Œå­—ç¬¦ä¸²

```js
//è‹±æ–‡å­—ç¬¦ä¸²
const message1 = 'hello'

//1ã€ç”±äºå®‰å…¨æ€§å’Œå¯ç”¨æ€§é—®é¢˜ï¼Œä¸æ¨èä½¿ç”¨ Buffer(),Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
// const buffer = new Buffer(message1)

//2ã€æ–¹å¼äºŒ Buffer.from()
const buffer1 = Buffer.from(message1)
const buffer2 = Buffer.from(message1, 'utf8') //ç¬¬äºŒä¸ªå‚æ•°é€‰é¡¹ï¼ŒæŒ‡å®šå­—ç¬¦ç¼–ç ï¼Œé»˜è®¤utf8ï¼Œ
console.log('buffer1:', buffer1); //<Buffer 68 65 6c 6c 6f>   ä¸€ä¸ªè‹±æ–‡ä¸€ä¸ªå­—èŠ‚â­

//ä¸­æ–‡å­—ç¬¦ä¸²
const message2 = 'ä½ å¥½'
const buffer3 = Buffer.from(message2) //é»˜è®¤æ˜¯utf8è¿›è¡Œç¼–ç 
const buffer4 = Buffer.from(message2, 'utf16le')
console.log('buffer3:', buffer3); // <Buffer e4 bd a0 e5 a5 bd> ç”Ÿåƒ»å­—å¤–ï¼Œä¸€ä¸ªæ±‰å­—utf8ç¼–ç æˆä¸ºä¸‰ä¸ªå­—èŠ‚â­
console.log('buffer4:', buffer4); // <Buffer 60 4f 7d 59>   ä¸åŒç¼–ç æ–¹å¼å­—èŠ‚ä¸åŒ

//toString()é»˜è®¤æ˜¯ä½¿ç”¨utf8è¿›è¡Œè§£ç 
console.log('buffer3ä½¿ç”¨utf8è§£ç :', buffer3.toString());//ä½ å¥½ 
console.log('buffer4ä½¿ç”¨utf16è§£ç :', buffer4.toString('utf16le'));//ä½ å¥½ 
//å¦‚æœç¼–ç ä¼ é€’äº†ç¼–ç æ–¹å¼ï¼Œè§£ç ä¹Ÿè¦ä¼ é€’ç›¸åº”çš„æ–¹å¼â­

//æ–¹å¼ä¸‰ï¼šallocæ–¹å¼
const buffer5 = Buffer.alloc(8)//size
console.log('buffer5', buffer5); //<Buffer 00 00 00 00 00 00 00 00>
buffer5[0] = 88 //10è¿›åˆ¶88=0x58
buffer5[1] = 0x88 
console.log('buffer5', buffer5); //<Buffer 58 88 00 00 00 00 00 00>
```

#### Bufferå’Œæ–‡ä»¶æ“ä½œ

```js
const fs = require('fs')

//ä¸æŒ‡å®šå­—ç¬¦ç¼–ç ï¼Œé»˜è®¤è¯»å–åˆ°çš„å°±æ˜¯äºŒè¿›åˆ¶Bufferæ•°æ®
fs.readFile('./aaa.txt', (err, data) => {
  if (err) return
  console.log(data);//<Buffer e5 b0 8f e7 b3 96 e7 b3 96 e5 b0 8f e6 b4 8b e6 b4 8b>
  console.log(data.toString());//å°ç³–ç³–å°æ´‹æ´‹
})
fs.readFile('./aaa.txt', { encoding: 'utf-8' }, (err, data) => {
  if (err) return
  console.log(data);//å°ç³–ç³–å°æ´‹æ´‹
})


// è¯»å–å›¾ç‰‡
fs.readFile('./pai.jpg', (err, data)=>{
  if(err) return
  console.log(data);//<Buffer 52 49 46 46 a6 19 00 00 57 45 42 50 56 50 38 ... 6524 more bytes>
  fs.writeFile('./newPar.jpg', data, err=> console.log(err))
})

//å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨sharpåº“ https://www.npmjs.com/package/sharp
const sharp = require('sharp')
fs.readFile('./pai.jpg', (err, data)=>{
  if(err) return
  sharp(data)
  .resize(100, 100)
  .toFile('./output.jpg', (err, info) => { 
    console.log(err);
    console.log(info);//å›¾ç‰‡ä¿¡æ¯
   })
})
```

### äº‹ä»¶å¾ªç¯ä¸å¼‚æ­¥IO

#### äº‹ä»¶å¾ªç¯æ˜¯ä»€ä¹ˆ

![image-20220330155033525](index.assets/image-20220330155033525.png) 

#### è¿›ç¨‹å’Œçº¿ç¨‹

è¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„ä¸¤ä¸ªæ¦‚å¿µï¼š        ï¼ˆç»´åŸºç™¾ç§‘ï¼‰

* è¿›ç¨‹ï¼ˆprocessï¼‰ï¼š`è®¡ç®—æœºå·²ç»è¿è¡Œçš„ç¨‹åº`
* çº¿ç¨‹ï¼ˆthreadï¼‰ï¼šæ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿è¡Œ`è¿ç®—è°ƒåº¦`çš„æœ€å°å•ä½

è§£é‡Šï¼š

* è¿›ç¨‹ï¼šå¯ä»¥è®¤ä¸ºæ˜¯å¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå°±ä¼šé»˜è®¤å¼€å¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆä¹Ÿå¯èƒ½æ˜¯å¤šè¿›ç¨‹ï¼‰
* çº¿ç¨‹ï¼šæ¯ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ç”¨æ¥æ‰§è¡Œç¨‹åºä¸­çš„ä»£ç ï¼Œè¿™ä¸ªçº¿ç¨‹è¢«ç§°ä¹‹ä¸ºä¸»çº¿ç¨‹ï¼Œ
* æ‰€ä»¥ä¹Ÿå¯ä»¥è¯´ï¼šè¿›ç¨‹æ˜¯çº¿ç¨‹çš„å®¹å™¨

##### å¤šè¿›ç¨‹å¤šçº¿ç¨‹å¼€å‘

![image-20220330160845621](index.assets/image-20220330160845621.png) 

##### æµè§ˆå™¨å’ŒJavaScript

![image-20220330161908864](index.assets/image-20220330161908864.png) 

#### `æµè§ˆå™¨`ä¸­çš„äº‹ä»¶å¾ªç¯

![image-20220330163929398](index.assets/image-20220330163929398.png) 

##### äº‹ä»¶å¤„ç†æµç¨‹

ä»£ç åˆ†ç±»ï¼š

* åˆå§‹åŒ–ä»£ç ï¼ˆåŒæ­¥ä»£ç ï¼‰ï¼šdomäº‹ä»¶ç›‘å¬ã€ajaxè¯·æ±‚ã€å®šæ—¶å™¨
* å›è°ƒä»£ç ï¼ˆå¼‚æ­¥ä»£ç ï¼‰ï¼šå¤„ç†å›è°ƒé€»è¾‘

jså¼•æ“æ‰§è¡Œä»£ç çš„åŸºæœ¬æµç¨‹

â€‹	`å…ˆæ‰§è¡Œåˆå§‹åŒ–ä»£ç ï¼Œå†æ‰§è¡Œå›è°ƒä»£ç `

â­â­æ‰§è¡Œæµç¨‹ï¼š

* æ‰§è¡Œåˆå§‹åŒ–ä»£ç ï¼Œå°†äº‹ä»¶å›è°ƒå‡½æ•°äº¤ç»™å¯¹åº”çš„ç®¡ç†æ¨¡å—
* å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ`äº‹ä»¶ç®¡ç†æ¨¡å—`ä¼šå°†å›è°ƒå‡½æ•°åŠå…¶æ•°æ®æ·»åŠ åˆ°`å›è°ƒé˜Ÿåˆ—`ä¸­
* åªæœ‰å½“åˆå§‹åŒ–ä»£ç æ‰§è¡Œå®Œåï¼Œæ‰ä¼šéå†è¯»å–å›åˆ°é˜Ÿåˆ—ä¸­çš„å›è°ƒå‡½æ•°æ‰§è¡Œ

![image-20220330213737064](index.assets/image-20220330213737064.png) 

##### å®ä»»åŠ¡(macrotask)ã€å¾®ä»»åŠ¡(microtask)

![image-20220330213934074](index.assets/image-20220330213934074.png) 

â­â­åœ¨é˜Ÿåˆ—é‡Œé¢æ—¢æœ‰å®ä»»åŠ¡ä¹Ÿæœ‰å¾®ä»»åŠ¡çš„æƒ…å†µä¸‹ï¼š

* ä¼š`å…ˆæ‰§è¡Œå¾®ä»»åŠ¡`ï¼Œå½“å¾®ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œä¼š`å†æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„ç¬¬ä¸€ä¸ªå‡½æ•°`
* ç¬¬ä¸€ä¸ªå‡½æ•°æ‰§è¡Œå®Œåä¸ä¼šç«‹é©¬æ‰§è¡Œä¸‹ä¸€ä¸ªå‡½æ•°ã€‚è€Œæ˜¯ä¼šåˆ¤æ–­ä¸€ä¸‹æ‰§è¡Œå®ä»»åŠ¡ç¬¬ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™`æœ‰æ²¡æœ‰æ·»åŠ æ–°çš„å¾®ä»»åŠ¡`
* æœ‰å°±å…ˆæŠŠå¾®ä»»åŠ¡æ‰§è¡Œäº†å†æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡  

> æ‰§è¡Œå®ä»»åŠ¡ä¹‹å‰ï¼Œä¿è¯å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯ç©ºçš„

##### é¢è¯•é¢˜*2

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <script>
      setTimeout(() => {
        console.log('set1')
        new Promise((resolve) => {
          resolve()
        }).then(() => {
          new Promise((resolve) => {
            resolve()
          }).then(() => {
            console.log('then4')
          })
          console.log('then2')
        })
      })

      new Promise((resolve) => {
        console.log('pr1')
        resolve()
      }).then(() => {
        console.log('then1')
      })

      setTimeout(() => {
        console.log('set2')
      })

      console.log(2)

      queueMicrotask(() => {
        console.log('queueMicrotask1')
      })

      new Promise((resolve) => {
        resolve()
      }).then(() => {
        console.log('then3')
      })
    </script>
  </body>
</html>
```

![image-20220330221931598](index.assets/image-20220330221931598.png) 

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <script>
      async function async1() {
        console.log('async1 start')
        await async2()
        console.log('async1 end')
      }

      async function async2() {
        console.log('async2')
      }

      console.log('script start')

      setTimeout(function () {
        console.log('setTimeout')
      }, 0)

      async1()

      new Promise((resolve, reject) => {
        console.log('promise1')
        resolve()
      }).then((res) => {
        console.log('promise2')
      })

      console.log('script end')
    </script>
  </body>
</html>
```

![image-20220330222113596](index.assets/image-20220330222113596.png) 

> **asyncã€awaitæ˜¯Promiseçš„ä¸€ä¸ªè¯­æ³•ç³–: **
>
> * æˆ‘ä»¬å¯ä»¥å°†**awaitå…³é”®å­—åé¢æ‰§è¡Œçš„ä»£ç **ï¼Œçœ‹åšæ˜¯åŒ…è£¹åœ¨`(resolveï¼Œreject) = { ... }`ä¸­çš„ä»£ç 
> * **awaitçš„ä¸‹é¢ä¸€æ¡è¯­å¥**ï¼Œå¯ä»¥çœ‹åšæ˜¯`then(res => { ... })`ä¸­çš„ä»£ç 
>
> ![image-20220330222336918](index.assets/image-20220330222336918.png) 

#### `node`ä¸­çš„äº‹ä»¶å¾ªç¯

##### Nodeçš„æ¶æ„åˆ†æ

![image-20220331094639839](index.assets/image-20220331094639839.png) 

##### é˜»å¡IOå’Œéé˜»å¡IOï¼ˆäº†è§£ï¼‰

![image-20220331111026329](index.assets/image-20220331111026329.png) 

##### éé˜»å¡IOçš„é—®é¢˜

![image-20220331112105366](index.assets/image-20220331112105366.png) 

##### é˜»å¡å’Œéé˜»å¡ã€åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«

é˜»å¡å’Œéé˜»å¡ä¸€èˆ¬è¯´çš„æ˜¯`ç³»ç»Ÿè°ƒç”¨`

![image-20220331112625743](index.assets/image-20220331112625743.png) 

##### Nodeäº‹ä»¶å¾ªç¯

![image-20220331140127911](index.assets/image-20220331140127911.png) 

##### Nodeä¸­çš„å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡

![image-20220331140631742](index.assets/image-20220331140631742.png) 

â­â­äº‹ä»¶å¾ªç¯å¤„ç†æµç¨‹ï¼š

* å…ˆæ‰§è¡Œ`åˆå§‹åŒ–ä»£ç ï¼ˆmain scriptï¼‰`
* å†æ‰§è¡Œ`å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„process.nextTick`(å®ƒæ˜¯å•ç‹¬é˜Ÿåˆ—)ï¼Œå†æ‰§è¡Œ`åˆ«çš„å¾®ä»»åŠ¡ï¼ˆpromise.thenã€queueMicrotask...ï¼‰`
* æœ€åæ‰§è¡Œ`å®ä»»åŠ¡é˜Ÿåˆ—ï¼štimerå®šæ—¶å™¨> å›è°ƒå‡½æ•°> IOäº‹ä»¶> æ£€æµ‹setImmediate> closeäº‹ä»¶`

> ç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åæ£€æŸ¥æœ‰æ²¡æœ‰äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡ï¼Œå’Œæµè§ˆå™¨äº‹ä»¶å¾ªç¯ç›¸åŒ

##### é¢è¯•é¢˜*2

> é¢è¯•é¢˜ä¸­å¾ˆå°‘ä¼šå‡ºç°IOäº‹ä»¶ï¼ŒIOäº‹ä»¶æ˜¯`ç³»ç»Ÿè°ƒç”¨`ï¼Œç³»ç»Ÿæ‰§è¡Œå®Œåå‘Šè¯‰ä½ ï¼Œæ‰§è¡Œæ—¶é—´ä¸ç¡®å®š

1

```js
async function async1() {
    console.log('async1 start');
    await async2()
    console.log('async1 end');
}

async function async2() {
    console.log('async2');
}

console.log('script start');

setTimeout(function() { console.log('setTimeout0'); }, 0)

setTimeout(() => { console.log('setTimeout2'); }, 300);

setImmediate(() => { console.log('setImmediate'); })

process.nextTick(() => { console.log('nextTick1'); })

async1()

process.nextTick(() => { console.log('nextTick2'); })

new Promise(resolve => {
    console.log('promise1');
    resolve()
    console.log('promise2');
}).then(res => {
    console.log('promise3');
})

console.log('script end');
```

![image-20220331142315657](index.assets/image-20220331142315657.png) 

2ï¼šsetTimeoutæ—¶é—´è®¾ç½®ä¸º0å’ŒsetImmediateè°å…ˆæ‰§è¡Œ

```js
setTimeout(() => {
    console.log('setTimeout')
}, 0)
setImmediate(() => {
    console.log('setImmediate');
})
```

äºŒè€…æ‰§è¡Œé¡ºåºä¸ä¸€å®š

å®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œé¡ºåºï¼š`timerå®šæ—¶å™¨> å›è°ƒå‡½æ•°> IOäº‹ä»¶> æ£€æµ‹setImmediate> closeäº‹ä»¶`

ææ¸…æ¥šä¸¤ç‚¹ï¼š`äº‹ä»¶å¾ªç¯æœ‰ä¸€ä¸ªåˆå§‹åŒ–æ—¶é—´ï¼Œtimerå®šæ—¶å™¨åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ä¹Ÿéœ€è¦ä¸€ä¸ªæ—¶é—´`

* äº‹ä»¶å¾ªç¯åˆå§‹åŒ–çš„æ—¶é—´å‡å¦‚æ˜¯20msï¼Œåˆå§‹åŒ–è¿‡åå¼€å§‹æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œå‡å¦‚å®šæ—¶å™¨åŠ å…¥é˜Ÿåˆ—æ‰€éœ€æ—¶é—´æ˜¯10msï¼Œè¿™æ—¶å°±ä¼šå…ˆæ‰§è¡ŒsetTimeoutï¼Œåæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå†æ‰§è¡Œcheckï¼ˆsetImmediateï¼‰
* ä½†æ˜¯ï¼Œå‡å¦‚åˆå§‹åŒ–æ—¶é—´åªéœ€è¦5msï¼Œå®šæ—¶å™¨åŠ å…¥åˆ°é˜Ÿåˆ—èŠ±äº†10msï¼Œè¿™æ—¶ä¼šå…ˆæ‰§è¡ŒsetImmediateï¼Œåœ¨æ‰§è¡ŒsetTimeout  

å‡ºç°è¿™ç§æƒ…å†µä¸æ˜¯ä¸¤ä¸ªé˜Ÿåˆ—è°ƒæ¢äº†é¡ºåºï¼Œè€Œæ˜¯`åŠ å…¥åˆ°é˜Ÿåˆ—çš„æ—¶é—´å…ˆå`

### Stream(æµ)

![image-20220331161804536](index.assets/image-20220331161804536.png) 

**æ–‡ä»¶è¯»å†™çš„Stream**

å¯ä»¥çœ‹ä½œæ˜¯ï¼šéœ€è¦è¯»å–çš„æ•°æ®æ”¾åœ¨ç®¡é“ï¼ˆç¼“å†²åŒºï¼‰ä¸­

![image-20220331162202837](index.assets/image-20220331162202837.png) 

æµçš„æ–¹å¼è¯»å– 

```js
const fs = require("fs")

//ä¼ ç»Ÿæ–¹å¼
fs.readFile("./aaa.txt", (err, data) => {
  console.log(data) //<Buffer e4 bd a0 e5 9c a8 e5 b9 b2 e4 bb 80 e4 b9 88>
})

//æµçš„æ–¹å¼è¯»å–
const reader = fs.createReadStream("./aaa.txt", {
  start: 3,
  end: 6,
  highWaterMark: 2,
})

//æ•°æ®è¯»å–è¿‡ç¨‹
// reader.on("data", (data) => {
//   console.log(data)
//   //ç¬¬ä¸‰ä¸ªå­—èŠ‚åˆ°ç¬¬å…­ä¸ªå­—èŠ‚ï¼ˆ0å¼€å§‹ï¼‰ï¼Œæ¯æ¬¡ä¸¤ä¸ªå­—èŠ‚
//   //<Buffer e5 9c>
//   //<Buffer a8 e5>
// })

//è¿˜å¯ä»¥å…ˆæš‚åœå†ç»§ç»­è¯»å–
reader.on("data", (data) => {
  console.log(data)
  reader.pause()

  setTimeout(() => {
    reader.resume()
  }, 1500)
})
reader.on("open", () => {
  console.log("æ–‡ä»¶è¢«æ‰“å¼€")
})
reader.on("end", () => {
  console.log("æ–‡ä»¶è¯»å–ç»“æŸ")
})
reader.on("close", () => {
  console.log("æ–‡ä»¶å…³é—­") //è¯»å–æ“ä½œå®Œæˆä¹‹åå…³é—­
})

```

æµçš„æ–¹å¼å†™å…¥

```js
const fs = require("fs")

// fs.writeFile("./test.txt", "leopaidaxing", { flag: "a" }, (err) => {
//   console.log(err)
// })

//æµçš„æ–¹å¼å†™å…¥
const writer = fs.createWriteStream("./textStream.txt", {
  flags: "a",
  start: 4,
})
//å†™å…¥å†…å®¹
writer.write("æ–‡ä»¶å†…å®¹", (err) => {
  if (err) return
  console.log("å†™å…¥æˆåŠŸ")
})
writer.write("ç¬¬äºŒæ¬¡å†™å…¥", (err) => {
  if (err) return
  console.log("ç¬¬äºŒæ¬¡å†™å…¥æˆåŠŸ")
})

// writer.close() //å¾ˆå°‘è°ƒç”¨ï¼Œå¤šè°ƒç”¨end()
//end()æ–¹æ³•å¯ä»¥ä¼ å‚ï¼›æ–‡ä»¶å†…å®¹ï¼Œå†™å…¥ä¹‹åä¼šè°ƒç”¨close()å°†æ–‡ä»¶å…³é—­
writer.end('helloworld') 

writer.on("close", () => {
  console.log("æ–‡ä»¶å·²ç»å…³é—­")
})
```

`pipe()`

```js
const fs = require("fs")
//æ–‡ä»¶è¯»å–å¹¶ç›´æ¥å†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­

//ä¼ ç»Ÿæ–¹æ³•
// fs.readFile("./aaa.txt", (err, data) => {
//   if (err) return
//   fs.writeFile("./writeA.txt", data, (err) => {
//     console.log(err)
//   })
// })

//pipe()
const reader = fs.createReadStream("./aaa.txt")
const writer = fs.createWriteStream("./writeB.txt")
reader.pipe(writer) //å°†è¯»å–åˆ°çš„æµç›´æ¥è¾“å‡º
writer.close()

```

## nodeå¼€å‘webæœåŠ¡å™¨

### webæœåŠ¡å™¨

æœåŠ¡å™¨ï¼šæä¾›èµ„æºçš„ä¸€å°ç”µè„‘

![image-20220402090126492](index.assets/image-20220402090126492.png) 

> å…¨å±€å®‰è£…`nodemon`ï¼Œä½¿ç”¨nodemonä»£æ›¿nodeæ‰§è¡Œjsæ–‡ä»¶ï¼šç›‘å¬æ–‡ä»¶æ”¹å˜è‡ªåŠ¨é‡æ–°æ‰§è¡Œ

### httpæ¨¡å—

åˆä½“éªŒ

```js
const http = require("http")

const server1 = http.createServer((request, response) => {
  response.end("server1")
})
server1.listen(4000, "0.0.0.0", () => {
  //ä¸»æœºåœ°å€é»˜è®¤0.0.0.0
  console.log("server1å·²ç»å¯åŠ¨")
})
//ç¬¬ä¸€ä¸ªå‚æ•°ç«¯å£å·å’Œç¬¬äºŒä¸ªå‚æ•°ä¸»æœºéƒ½æ˜¯å¯é€‰çš„
// server1.listen(() => {
//     console.log('server1å·²ç»å¯åŠ¨');
//     console.log(server1.address().port); //å¯ä»¥ä½¿ç”¨address().portæŸ¥çœ‹ç«¯å£å·
// })

//æ–¹å¼2
const server2 = new http.Server((request, response) => {
  //new http.Server  ä¸¤ç§æ–¹å¼å¹¶æ— æœ¬è´¨åŒºåˆ«
  response.end("server2")
})
server2.listen(4001, () => {
  console.log("server2å·²ç»å¯åŠ¨")
})
```

ä¸¤ç§æ–¹å¼åº•å±‚å®ç°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯`new Server`

#### ä¸»æœºã€ç«¯å£å·

![image-20220402102230425](index.assets/image-20220402102230425.png) 

ä¸»æœºåœ°å€å†™`0.0.0.0`ï¼Œå¯ä»¥é€šè¿‡localhostã€127.0.0.1ã€ç”µè„‘çš„IPåœ°å€ ä¸‰ç§æ–¹å¼æ¥è®¿é—®

#### requestå¯¹è±¡

responseç»§æ‰¿è‡ª`stream.Readable`

urlã€methodã€headers

##### method

![image-20220402155912497](index.assets/image-20220402155912497.png) 

```js
const http = require("http")
const url = require("url")
const qs = require("querystring")

const server1 = http.createServer((request, response) => {
  console.log(request.url) //æ¥å£åŠå‚æ•°ä¿¡æ¯  /users
  console.log(request.method) //è¯·æ±‚æ–¹å¼ï¼Œé»˜è®¤GETè¯·æ±‚
  console.log(request.headers) //è¯·æ±‚å¤´

  /**
   * urlç›¸å…³
   */

  // console.log(url.parse(request.url)) //urlæ¨¡å—æœ‰ä¸ªparseæ–¹æ³•å¯ä»¥æ‹¿åˆ°urlå¯¹è±¡
  // const { pathname, query } = url.parse(request.url) //å¯¹è±¡è§£æ„
  // console.log(pathname) //ä¾‹å¦‚/login
  // console.log(query) //ä¾‹å¦‚user=wy&password=123123151

  // console.log(qs.parse(query)) //queryå¯¹è±¡
  // const { user, password } = qs.parse(query)
  // console.log(user) //ç”¨æˆ·ä¿¡æ¯å†…å®¹
  // console.log(password) //å¯†ç ä¿¡æ¯å†…å®¹

  /**
   * methodç›¸å…³
   * POST:postæ–¹å¼å‚æ•°æ˜¯åœ¨bodyé‡Œé¢ä¼ å…¥ï¼Œpostmané‡Œé¢ç‚¹å‡»bodyï¼Œç‚¹rowï¼Œtexté€‰ä¸ºjsonï¼Œå³å¯å†™jsonæ ¼å¼çš„å‚æ•°
   */
  const { pathname } = url.parse(request.url)
  if (pathname === "/login") {
    if (request.method === "POST") {
      //æ‹¿åˆ°bodyä¸­çš„æ•°æ®
      // request.setEncoding('utf-8')//æ–‡å­—ï¼Œè§†é¢‘éŸ³é¢‘è¦æŒ‡å®šbinaryï¼Œè¿™é‡ŒæŒ‡å®šäº†ç¼–ç æ–¹å¼ä»¥åä¸‹é¢å°±å¯ä»¥ä¸ç”¨å†™data.toString()ï¼Œç›´æ¥æ‰“å°data
      request.on("data", (data) => {
        //bodyä¸­å†™å…¥çš„æ—¶å€™ä½¿ç”¨æµçš„æ–¹å¼è¿›è¡Œå†™å…¥çš„ï¼Œæ‰€ä»¥è¦è°ƒç”¨dataäº‹ä»¶
        console.log(data) //è¿™é‡Œæ‹¿åˆ°çš„bodyæ•°æ®æ˜¯Buffer
        const { username, password } = JSON.parse(data.toString())
        console.log(username) //ç”¨æˆ·ä¿¡æ¯å†…å®¹
        console.log(password) //å¯†ç ä¿¡æ¯å†…å®¹
      })
      request.on('end', () => {
        response.end('server1å“åº”')
      })
    }
  }
})
server1.listen(4000, "0.0.0.0", () => {
  console.log("server1å·²ç»å¯åŠ¨")
})
```

##### headers

![image-20220402160604425](index.assets/image-20220402160604425.png) 

#### responseå¯¹è±¡

##### å“åº”ç»“æœ

responseæ˜¯ç»§æ‰¿è‡ª`stream.Writable`çš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨`.end(),.write(),æ²¡æœ‰æä¾›.close()`ï¼Œè€Œä¸”resè¿”å›ç»“æœæ˜¯é€šè¿‡`æµ`çš„æ–¹å¼è¿”å›

è°ƒç”¨`.end('aaa')`ï¼Œç›¸å½“äºå…ˆè°ƒç”¨`.write('aaa')`ï¼Œå†è°ƒç”¨`.end()`

![image-20220402091609001](index.assets/image-20220402091609001.png) 

##### [å“åº”çŠ¶æ€ç ](https://tool.oschina.net/commons?type=5)

![image-20220402164657607](index.assets/image-20220402164657607.png) 

```js
const http = require("http")
const url = require("url")
const qs = require("querystring")

const server1 = http.createServer((request, response) => {
  //è®¾ç½®çŠ¶æ€ç 
  //æ–¹å¼ä¸€ï¼š
  // response.statusCode = 400
  //æ–¹å¼äºŒ
  // response.writeHead(503)

  //å“åº”å¤´
  //æ–¹å¼ä¸€
  // response.setHeader('Content-Type', 'text/plain;charset=utf8')
  //å“åº”ä»€ä¹ˆæ–‡ä»¶èµ„æºï¼ŒContent-Typeå°±æŒ‡å®šä»€ä¹ˆç±»å‹
  // response.setHeader('Content-Type', 'image/jpeg')
  //æ–¹å¼äºŒ
  response.writeHead(200, {
    "Content-Type": "text/html;charset=utf8",
  })

  //å“åº”ç»“æœ
  // responseå¯¹è±¡æœ‰ä¸€ä¸ªwriteæ–¹æ³•ï¼Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€å“åº”æ•°æ®ï¼Œå¯ä»¥å‘é€å¤šæ¬¡ï¼Œä½†æ˜¯æœ€åä¸€å®šè¦
  // ç”¨endæ–¹æ³•ç»“æŸå“åº”ï¼Œä¸ç„¶æœåŠ¡å™¨ä¼šä¸€ç›´ç­‰å¾…â­
  // response.write('null')
  // response.end()
  // å¾ˆå°‘ç”¨writeï¼Œå¯ä»¥ç›´æ¥åœ¨è¯·æ±‚ç»“æŸendé‡Œé¢è·Ÿä¸Šè¯·æ±‚æ•°æ®
  response.end("<h1>hello</h1>")
})
server1.listen(4000, "0.0.0.0", () => {
  console.log("server1å·²ç»å¯åŠ¨")
})

```

##### [Content-type](https://tool.oschina.net/commons)

#### httpæ¨¡å—å‘é€ç½‘ç»œè¯·æ±‚

```js
//å‘å…¶ä»–æœåŠ¡å™¨å‘é€ç½‘ç»œè¯·æ±‚
//axiosæ—¢æ”¯æŒå‰ç«¯ï¼ˆä½¿ç”¨çš„æ˜¯å°è£…xmlhttprequestï¼‰ï¼Œä¹Ÿæ”¯æŒnodeï¼ˆä½¿ç”¨çš„æ˜¯httpæ¨¡å—ï¼‰

const { resolveAny } = require('dns')
const http = require('http')
http.get('http://127.0.0.1:4000', (res) => {
  //resä¸æ˜¯ç»“æœ
  res.on('data', (data) => {
    console.log('getè¯·æ±‚çš„ç»“æœâ€œ', data)
    console.log(data.toString())
  })
  res.on('end', () => {
    console.log('è·å–åˆ°äº†getæ‰€æœ‰ç»“æœ')
  })
})

//POSTè¯·æ±‚
//POSTè¯·æ±‚æ²¡æœ‰ç›´æ¥çš„postæ–¹æ³•
const req = http.request(
  {
    method: 'POST',
    hostname: '127.0.0.1',
    port: 4000,
  },
  (res) => {
    res.on('data', (data) => {
      console.log('POSTè¯·æ±‚')
      console.log(data.toString())
    })
    res.on('end', () => {
      console.log('POSTè¯·æ±‚å·²è·å–æ‰€æœ‰ç»“æœ')
    })
  }
)
req.end() //postè¯·æ±‚å¿…é¡»ä»¥endæ–¹æ³•ç»“æŸè¯·æ±‚
```

### nodeä¸­æ–‡ä»¶ä¸Šä¼ å¹¶å­˜å…¥æœåŠ¡å™¨

æ–‡ä»¶ä¸Šä¼ æœ¬è´¨å°±æ˜¯è¡¨å•æäº¤ï¼Œä½¿ç”¨postè¯·æ±‚

* `raw`æ–¹å¼ä¸€èˆ¬å°±æ˜¯ä¼ jsonæ ¼å¼çš„æ•°æ®
* `form-data`æ–¹å¼ç°åœ¨å¤šæ•°éƒ½æ˜¯è¿›è¡Œæ–‡ä»¶ä¸Šä¼ ï¼Œä½†æ˜¯æœåŠ¡å™¨è§£æèµ·æ¥ä¹Ÿå¾ˆéº»çƒ¦ï¼Œä¸€èˆ¬æ˜¯ç”¨æ¡†æ¶ï¼Œæ¯”å¦‚è¯´`expressä¸­çš„multeråº“`

httpåŸç”Ÿæ–‡ä»¶ä¸Šä¼ å†™å…¥

> é”™è¯¯æ–¹å¼âŒ
>
> ```js
> const http = require('http')
> const fs = require('fs')
> 
> const server = http.createServer((req, res) => {
>   if (req.url === '/upload') {
>     if (req.method === 'POST') {
>       const fileWriter = fs.createWriteStream('./foo.png', { flags: 'a+' })
>       req.on('data', (data) => {
>         fileWriter.write(data) //ç›´æ¥å°†å­—èŠ‚æµå†™å…¥,ä½†æ˜¯å­—èŠ‚æµæ˜¯æœ‰é—®é¢˜çš„â­ï¼Œå…¶ä¸­åŒ…å«çš„ä¸åªæ˜¯æ–‡ä»¶çš„å†…å®¹ä¿¡æ¯ï¼Œè¿˜åŒ…å«å…¶ä»–ä¿¡æ¯ï¼ˆå†™å…¥æ—¶ä¸æ˜¯çº¯å›¾ç‰‡æ•°æ®ï¼‰
>       })
>       req.on('end', () => {
>         res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
>       })
>     }
>   }
> })
> server.listen('4000', () => {
>   console.log('server start!')
> })
> ```
>
> ![image-20220406205912652](index.assets/image-20220406205912652.png) 
>
> ![image-20220406213055901](index.assets/image-20220406213055901.png) 

```js
const http = require('http')
const qs = require('querystring')
const fs = require('fs')

const server = http.createServer((req, res) => {
  if (req.url === '/upload') {
    if (req.method === 'POST') {
      //â­å›¾ç‰‡æ–‡ä»¶å¿…é¡»è®¾ç½®æˆäºŒè¿›åˆ¶çš„ç¼–ç ï¼Œé»˜è®¤æ˜¯utf-8
      req.setEncoding('binary')

      let body = '' //ç”¨äºå‚¨å­˜æ–‡ä»¶ä¿¡æ¯
      //è·å–boundary
      const totalBoundary = req.headers['content-type'].split(';')[1]
      const boundary = totalBoundary.split('=')[1]
    //   console.log(boundary);

      req.on('data', (data) => {
        //data:æ‹¿åˆ°çš„æ–‡ä»¶æ•°æ®
        body += data //bodyæ˜¯å­—ç¬¦ä¸²ï¼Œdataæ–‡ä»¶æ•°æ®äº‹bufferï¼Œä¼šé»˜è®¤å°†å…¶è½¬åŒ–ä¸ºå­—ç¬¦å‹
      })
      req.on('end', () => {
        // console.log(body)
        //å¤„ç†body,è·å–ä¸­é—´çœŸæ­£çš„æ–‡ä»¶ä¿¡æ¯æ‰èƒ½æ­£ç¡®å†™å…¥
        //1ã€è·å– Content-Type: image/png (ä¸åŒæ–‡ä»¶Content-Typeæ˜¯ä¸åŒçš„)
        const payload = qs.parse(body, '\r\n', ': ')
        // console.log(payload)
        const type = payload['Content-Type'] //image/png
        //åœ¨image/pngçš„ä½ç½®è¿›è¡Œæˆªå–
        const typeIndex = body.indexOf(type)
        const typeLength = type.length
        let imageData = body.substring(typeIndex + typeLength) //Content-Type: image/pngåé¢çš„æ‰€æœ‰æ•°æ®
        //3ã€å°†ä¸­é—´çš„ä¸¤ç©ºæ ¼å»æ‰
        imageData = imageData.replace(/^\s\s*/, '') // \r\n\r\n
        //4ã€å°†æœ€åçš„boundaryå»æ‰
        imageData = imageData.substring(0, imageData.indexOf(`--${boundary}--`))//å‰åä¼šæœ‰--

        fs.writeFile('./foo.png', imageData, 'binary', (err) => {
          res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
        })
      })
    }
  }
})
server.listen('4000', () => {
  console.log('server start!')
})
```

## express

### è®¤è¯†webæ¡†æ¶

![image-20220407222542570](index.assets/image-20220407222542570.png) 

### åˆå§‹åŒ–é¡¹ç›®

#### å®‰è£…express

* æ–¹å¼ä¸€ï¼šé€šè¿‡`expressè„šæ‰‹æ¶`åˆ›å»ºåº”ç”¨éª¨æ¶

å®‰è£…`express-generator`è„šæ‰‹æ¶

```shell
# å…¨å±€å®‰è£…è„šæ‰‹æ¶
npm i -g express-generator
# åˆ›å»ºé¡¹ç›®
express express-server-demo
# å®‰è£…ä¾èµ–
npm i
# å¯åŠ¨é¡¹ç›®
node[nodemon] bin/www
```

* æ–¹å¼äºŒï¼šä»é›¶æ­å»ºä¸€ä¸ªexpressåº”ç”¨ç»“æ„

```shell
npm init -y
npm i express
```

```js
//1ã€å¯¼å…¥
const express = require('express')
//2ã€åˆ›å»ºapp  expressæ˜¯ä¸€ä¸ªå‡½æ•°
const app = express()

// é»˜è®¤è·¯å¾„è¯·æ±‚åšæ“ä½œ
app.get('/', (req, res, next) => {
  res.end('helloè¿™æ˜¯é»˜è®¤è¯·æ±‚')
})
//æƒ³å‘ä»€ä¹ˆè¯·æ±‚ï¼Œå°±æ€ä¹ˆé…ç½®
app.post('/login', (req, res, next) => {
  res.end('è¿™æ˜¯postè¯·æ±‚~')
})

//3ã€ç›‘å¬
app.listen(8000, () => {
  console.log('8000ç«¯å£å·²ç»å¯åŠ¨')
})
```

### ä¸­é—´ä»¶

* expressåº”ç”¨ç¨‹åºæœ¬è´¨ä¸Šæ˜¯`ä¸€ç³»åˆ—ä¸­é—´ä»¶å‡½æ•°çš„è°ƒç”¨`
* ä¸­é—´ä»¶æœ¬è´¨æ˜¯ä¼ é€’ç»™expressä¸€ä¸ªå›è°ƒå‡½æ•°
* å›è°ƒå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œ`è¯·æ±‚å¯¹è±¡request`ï¼Œ`å“åº”å¯¹è±¡response`ï¼Œ`ç”¨äºæ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„nextå‡½æ•°`

#### æ™®é€šä¸­é—´ä»¶

æ™®é€šä¸­é—´ä»¶ï¼Œä»€ä¹ˆè¯·æ±‚ã€ä»€ä¹ˆurléƒ½ä¼šåŒ¹é…ä¸Šï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶

> next()ä¸è·Ÿå‚æ•°ï¼Œè·Ÿä¸Šå‚æ•°è¡¨ç¤ºæŠ¥é”™â­

* è¿™ç§æ™®é€šä¸­é—´ä»¶å†™äº†å¤šä¸ªä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œ`é»˜è®¤ä¼šæ‰§è¡Œç¬¬ä¸€ä¸ª`ï¼Œå¦‚æœæƒ³å‘ä¸‹æ‰§è¡Œï¼Œå¿…é¡»æ‰§è¡Œ`next()`
* next()å’Œres.end()æ²¡æœ‰å¿…ç„¶å…³ç³»ï¼Œä½†æ˜¯è¯·æ±‚-å“åº”å‘¨æœŸï¼ˆres.endï¼‰ç»“æŸï¼Œä¸‹é¢çš„ä¸­é—´ä»¶å†æ‰§è¡Œres.endå°±ä¼šæŠ¥é”™ï¼ˆç»“æŸä¸€æ¬¡å°±è¡Œäº†å•Šï¼‰
* ä¸€èˆ¬æƒ³é€šè¿‡nextæ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„è¯ï¼Œæ˜¯åœ¨æœ€åä¸€ä¸ªä¸­é—´ä»¶é‡Œé¢æ‰§è¡Œres.end()ç»“æŸå“åº”
* ä¸­é—´ä»¶æ‰§è¡Œå®Œäº†ä¾ç„¶æ²¡æœ‰`res.end()`è¿”å›ç»“æœå°±ä¼šè¿”å›`not found`â­

```js
const express = require('express')
const app = express()

//æ™®é€šä¸­é—´ä»¶
app.use((req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬1ä¸ªæ™®é€šçš„ä¸­é—´ä»¶')
  //   res.end('middleware')//è¿™é‡Œå“åº”ä¹‹åè¿˜æ˜¯å¯ä»¥æ‰§è¡Œnext()ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä½†æ˜¯ä¸‹é¢å†æœ‰end()å°±ä¼šæŠ¥é”™
  next()
})
app.use((req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬2ä¸ªæ™®é€šçš„ä¸­é—´ä»¶')
  next()
})
app.use((req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬3ä¸ªæ™®é€šçš„ä¸­é—´ä»¶')
  res.end('hello middleware')
})

app.listen(8000, () => {
  console.log('8000ç«¯å£å·²å¯åŠ¨')
})
```

#### pathè·¯å¾„åŒ¹é…çš„ä¸­é—´ä»¶

åªæœ‰åŒ¹é…çš„urlæ‰ä¼šåŒ¹é…ä¸Šï¼Œæ— è®ºä»€ä¹ˆè¯·æ±‚éƒ½å¯ä»¥

```js
const express = require('express')
const app = express()

//ä¸ç®¡ä»€ä¹ˆä¸­é—´ä»¶åªè¦åŒ¹é…ä¸Šå°±ä¼šå…ˆæ‰§è¡Œï¼Œå¦‚æœæƒ³æ‰§è¡Œä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œnextå‡½æ•°
app.use((req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬1ä¸ªæ™®é€šçš„ä¸­é—´ä»¶')
  next()
})
app.use('/home', (req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬1ä¸ªpathä¸­é—´ä»¶')
  next()
})
//ä¸­é—´ç©¿æ’æ™®é€šä¸­é—´ä»¶ï¼Œä¹Ÿéƒ½æ˜¯ä¾æ¬¡æ‰§è¡Œ
app.use((req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬2ä¸ªæ™®é€šçš„ä¸­é—´ä»¶')
  next()
})
app.use('/home', (req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬2ä¸ªpathä¸­é—´ä»¶')
  res.end('path middleware')
})

app.listen(4000, () => {
  console.log('4000ç«¯å£å·²å¯åŠ¨')
})
```

#### pathè·¯å¾„å’Œmethodæ–¹æ³•åŒ¹é…çš„ä¸­é—´ä»¶

> ä¸€èˆ¬æ²¡æœ‰å•ç‹¬åŒ¹é…æ–¹æ³•çš„ä¸­é—´ä»¶

```js
const express = require('express')
const app = express()

//pathå’Œmethodéƒ½åŒ¹é…ä¸­é—´ä»¶
app.use((req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬1ä¸ªæ™®é€šçš„ä¸­é—´ä»¶')
  next()
})
app.get('/home', (req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬1ä¸ªpath,methodä¸­é—´ä»¶')
  res.end('path home and method middleware')
})
app.post('/home', (req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬2ä¸ªpath,methodä¸­é—´ä»¶')
  res.end('path home and method middleware')
})

app.listen(4000, () => {
  console.log('4000ç«¯å£å·²å¯åŠ¨')
})
```

#### è¿ç»­æ³¨å†Œä¸­é—´ä»¶

```js
const express = require('express')
const app = express()

//è¿ç»­æ³¨å†Œä¸­é—´ä»¶ ,è¿ç»­å¤šä¸ªå›è°ƒå‡½æ•°æ³¨å†Œå¤šä¸ªä¸­é—´ä»¶
//åªè¦åŒ¹é…çš„ä¸Šï¼Œç›¸åŒçš„pathå’Œmethodå†™å¤šä¸ªä¹Ÿæ²¡æœ‰é—®é¢˜
app.get('/home', (req, res, next) => {
  console.log('æ³¨å†Œäº†ç¬¬1ä¸ªpath,methodä¸­é—´ä»¶')
  next()
})
app.get(
  '/home',
  (req, res, next) => {
    console.log('æ³¨å†Œäº†ç¬¬2ä¸ªpath,methodä¸­é—´ä»¶')
    next()
  },
  (req, res, next) => {
    console.log('æ³¨å†Œäº†ç¬¬3ä¸ªpath,methodä¸­é—´ä»¶')
    next()
  },
  (req, res, next) => {
    console.log('æ³¨å†Œäº†ç¬¬4ä¸ªpath,methodä¸­é—´ä»¶')
    res.end('path home and method middleware')
  }
)

app.listen(4000, () => {
  console.log('4000ç«¯å£å·²å¯åŠ¨')
})
```

### ä¸­é—´ä»¶åº”ç”¨-è§£æè¯·æ±‚æ•°æ®

textæ ¼å¼å†…å®¹å¯ä»¥ç›´æ¥è·å–ï¼Œä½†æ˜¯jsonæ ¼å¼æˆ–è€…å…¶ä»–æ ¼å¼åˆ™éœ€è¦è§£æ

```js
const express = require('express')
const app = express()

//jsonæ–¹å¼
//è¿™æ ·åˆ¤æ–­ï¼Œå°±ä¼šå…ˆæŠŠjsonæ–¹å¼è¯·æ±‚çš„æ•°æ®æ”¾åœ¨req.bodyé‡Œé¢ï¼Œçœ‹pathå’Œmethodæ˜¯ä»€ä¹ˆå†åœ¨ä¸‹é¢çš„ä¸­é—´ä»¶ä¸­æ‹¿åˆ°æ•°æ®
app.use((req, res, next) => {
  if (req.headers['content-type'] === 'application/json') {
    req.on('data', (data) => {
      const info = JSON.parse(data.toString())
      req.body = info //ä¿å­˜åœ¨req.bodyé‡Œé¢â­
    })
    req.on('end', () => {
      next()
    })
  } else {
    next()
  }
})

app.post('/home', (req, res, next) => {
  console.log(req.body)
  res.end('home path')
})
app.post('/login', (req, res, next) => {
  console.log(req.body)
  res.end('login path')
})

app.listen(8000, () => {
  console.log('8000ç«¯å£')
})
```

#### `body-parser`è§£æjsonå’Œx-www-form-urlencodedæ ¼å¼æ•°æ®

* `app.use(express.json())`
* `app.use(express.urlencoded({ extended: true }))`

ä¹Ÿæ˜¯åœ¨`è¯·æ±‚å¯¹è±¡request`çš„`body`å±æ€§ä¸­æ‹¿åˆ°

```js
const express = require('express')
const app = express()

//ä¸Šé¢è¿™ç§å°è£…ä½¿ç”¨ä¸€ä¸ªåº“å®ç°body-parserï¼Œè¿™ä¸ªåº“çš„ç±»ä¼¼åŠŸèƒ½(ä¸æ˜¯è¿™ä¸ªåº“)åœ¨expressçš„4.16.xç‰ˆæœ¬å†…ç½®æˆäº†å‡½æ•°
app.use(express.json()) //jsonæ ¼å¼æ•°æ®ä¸Šä¼ â­

// extended:
// true:é‚£ä¹ˆå¯¹urlencodedè¿›è¡Œè§£ææ—¶ï¼Œå®ƒä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹åº“:qs âˆš
// false:é‚£ä¹ˆå¯¹urlencodedè¿›è¡Œè§£ææ—¶ï¼Œå®ƒä½¿ç”¨çš„æ˜¯Nodeå†…ç½®å—:querystring
app.use(express.urlencoded({ extended: true })) //x-www-form-urlencodedæ ¼å¼æ•°æ®ä¸Šä¼ â­

app.post('/home', (req, res, next) => {
  console.log(req.body)
  res.end('home path')
})
app.post('/login', (req, res, next) => {
  console.log(req.body)
  res.end('login path')
})

app.listen(8000, () => {
  console.log('8000ç«¯å£')
})

```

#### form-dataæ ¼å¼æ•°æ®è§£æ

ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨form-dataä¼šçœ‹ä½œæ˜¯`å‘æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶ï¼ˆä¿¡æ¯ï¼‰`

è§£æform-dataæ ¼å¼çš„æ•°æ®ä½¿ç”¨`multer`

```shell
npm i multer
```

ä¹Ÿæ˜¯åœ¨`è¯·æ±‚å¯¹è±¡request`çš„`body`å±æ€§ä¸­æ‹¿åˆ°

```js
const express = require('express')
const multer = require('multer') //å®‰è£…ã€å¯¼å…¥multer

const app = express()

const upload = multer() //ä¸€èˆ¬å‘½åä¸ºupload
app.use(upload.any()) //form-dataæ ¼å¼ä¸Šä¼ ä¿¡æ¯è§£ææ–¹å¼ï¼Œany()çš„ä½œç”¨æ˜¯å¯ä»¥è§£ææ–‡ä»¶ç±»å‹ä»¥å¤–çš„ä¿¡æ¯

app.post('/login', (req, res, next) => {
  console.log(req.body)
  res.end('ç”¨æˆ·ç™»å½•æˆåŠŸ')
})

app.listen(4000, () => {
  console.log('form-dataè§£æä¸Šä¼ æœåŠ¡å™¨å¼€å¯æˆåŠŸ')
})
```

```js
//â­æ°¸è¿œä¸è¦å°†upload.any()ä½œä¸ºå…¨å±€ä¸­é—´ä»¶ä½¿ç”¨
//è¿ç»­æ³¨å†Œä¸­é—´ä»¶çš„æ–¹å¼ä½¿ç”¨ï¼Œå•ç‹¬ç»™loginæ¥å£åšè§£æ
app.post('/login', upload.any(), (req, res, next) => {
  console.log(req.body)
  res.end('ç”¨æˆ·ç™»å½•æˆåŠŸ')
})
```

![image-20220410154234220](index.assets/image-20220410154234220.png) 

#### form-dataæ–‡ä»¶ä¸Šä¼ è§£æ

`upload.single(key)`  å•æ–‡ä»¶ä¸Šä¼ 

`upload.array(key, 4)`  å¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæœ€å¤š4ä¸ª

`upload.fields([
   { name: 'file', maxCount: 2 },
   { name: 'haha', maxCount: 2 },
])`  å¤šæ–‡ä»¶å¤šå­—æ®µä¸Šä¼ 

```js
const express = require('express')
const multer = require('multer') //å¯¼å…¥multer

const app = express()

const upload = multer({
  dest: './uploads/', //ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶åœ¨å“ªä¸ªæ–‡ä»¶å¤¹
})

//form-dataæ ¼å¼æ–‡ä»¶ä¸Šä¼ æ¥å£
// fileä¸ºè°ƒç”¨æ¥å£ä¼ é€’æ–‡ä»¶ä¿¡æ¯çš„key
app.post('/upload', upload.single('file'), (req, res, next) => {
  //ä¸­é—´è¿˜è¦æ’å…¥ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºè·å–ä¸Šä¼ çš„æ–‡ä»¶å¹¶ä¸”ä¿å­˜
  console.log(req.body) //æ‹¿åˆ°æ–‡æœ¬åŸŸä¿¡æ¯
  console.log(req.file) //æ‹¿åˆ°æ–‡ä»¶ä¿¡æ¯ï¼Œåªä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
  res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
})

// ä¸Šä¼ å¤šä¸ªæ–‡ä»¶keyéƒ½è¦å«file
app.post('/uploads', upload.array('file'), (req, res, next) => {
  //ä¸­é—´è¿˜è¦æ’å…¥ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºè·å–ä¸Šä¼ çš„æ–‡ä»¶å¹¶ä¸”ä¿å­˜
  console.log(req.body) //æ‹¿åˆ°æ–‡æœ¬åŸŸä¿¡æ¯
  console.log(req.files) //æ–‡ä»¶ä¿¡æ¯æ•°ç»„ï¼Œå¤šä¸ªæ–‡ä»¶
  res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
})

app.listen(4000, () => {
  console.log('form-dataè§£æä¸Šä¼ æœåŠ¡å™¨å¼€å¯æˆåŠŸ')
})
```

![image-20220410150643752](index.assets/image-20220410150643752.png) 

> ![image-20220410153146835](index.assets/image-20220410153146835.png) 
>
> å¦‚æœä½¿ç”¨äº†æ™®é€šä¸­é—´ä»¶`any()`è§£æï¼Œåªèƒ½åœ¨`filesæ•°ç»„`ä¸­è·å–æ–‡ä»¶ä¿¡æ¯ï¼Œå¯ä»¥å°†`any()`å®šä¹‰ä¸ºè¿ç»­ä¸­é—´ä»¶
>
> ![image-20220410154234220](index.assets/image-20220410154234220.png) 

è¿™æ ·ä¸Šä¼ çš„æ–‡ä»¶æ²¡æœ‰`æ‰©å±•å`å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å­˜å‚¨ä¿¡æ¯æ¥è®¾ç½®ï¼š`upload.diskStorage()`

```js
// const { json } = require('express');
const path = require('path')
const express = require('express')
const multer = require('multer') //å¯¼å…¥multer

const app = express()

app.use(express.json())
app.use(express.urlencoded({ extended: true }))

const storage = multer.diskStorage({
  //æ–‡ä»¶ä¿å­˜ä½ç½®
  destination: (req, file, cb) => {
    cb(null, './uploads/') //cbæ˜¯å›è°ƒå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯ä¿¡æ¯
  },
  //å®šä¹‰ä¸Šä¼ çš„æ–‡ä»¶åå­—
  filename: (req, file, cb) => {
    //åå­—ç”¨æ—¶é—´æˆ³æ¥å‘½åï¼Œé¿å…åŒåè¦†ç›–ï¼Œpath.extnameæ˜¯è·å–æ–‡ä»¶æ‰©å±•åï¼Œfile.originalnameå°±æ˜¯ä¸Šä¼ çš„æ–‡ä»¶åŸå§‹åå­—ï¼ŒåŸå§‹åå­—ä¸€èˆ¬ä¸ä¼šä¿å­˜ï¼Œé¿å…é‡å¤
    cb(null, Date.now() + path.extname(file.originalname))
  },
})
const upload = multer({
  // dest: './uploads/' //ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶åœ¨å“ªä¸ªæ–‡ä»¶å¤¹
  storage, //è‡ªå®šä¹‰å­˜å‚¨ä¿¡æ¯ï¼šä¸Šä¼ çš„æ–‡ä»¶ä¿å­˜å¹¶å®šä¹‰æ–‡ä»¶åå­—
})

// form-dataæ ¼å¼ä¸Šä¼ æ–‡æœ¬åŸŸä¿¡æ¯æ¥å£
//form-dataæ ¼å¼ä¸Šä¼ ä¿¡æ¯è§£ææ–¹å¼ï¼Œany()çš„ä½œç”¨æ˜¯å¯ä»¥è§£ææ–‡ä»¶ç±»å‹ä»¥å¤–çš„ä¿¡æ¯(æ–‡æœ¬åŸŸä¿¡æ¯)
app.post('/login', upload.any(), (req, res, next) => {
  console.log(req.body)
  res.end('ç”¨æˆ·ç™»å½•æˆåŠŸ')
})

// app.post('/upload', upload.single('file'), (req, res, next) => {
//   //ä¸­é—´è¿˜è¦æ’å…¥ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºè·å–ä¸Šä¼ çš„æ–‡ä»¶å¹¶ä¸”ä¿å­˜
//   console.log(req.body) //æ‹¿åˆ°æ–‡æœ¬åŸŸä¿¡æ¯
//   console.log(req.file) //æ‹¿åˆ°æ–‡ä»¶ä¿¡æ¯ï¼Œåªä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
//   console.log(req.files) //æ–‡ä»¶ä¿¡æ¯æ•°ç»„ï¼Œå¤šä¸ªæ–‡ä»¶
//   res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
// })

//å¤šä¸ªkeyå­—æ®µä¸Šä¼ 
app.post(
  '/upload',
  upload.fields([
    { name: 'file', maxCount: 2 },
    { name: 'haha', maxCount: 2 },
  ]),
  (req, res, next) => {
    //ä¸­é—´è¿˜è¦æ’å…¥ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºè·å–ä¸Šä¼ çš„æ–‡ä»¶å¹¶ä¸”ä¿å­˜
    console.log(req.body) //æ‹¿åˆ°æ–‡æœ¬åŸŸä¿¡æ¯
    console.log(req.file) //æ‹¿åˆ°æ–‡ä»¶ä¿¡æ¯ï¼Œåªä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
    console.log(req.files) //æ–‡ä»¶ä¿¡æ¯æ•°ç»„ï¼Œå¤šä¸ªæ–‡ä»¶
    res.end('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ')
  }
)

app.listen(4000, () => {
  console.log('form-dataè§£æä¸Šä¼ æœåŠ¡å™¨å¼€å¯æˆåŠŸ')
})

```

### ä¸­é—´ä»¶åº”ç”¨-æ—¥å¿—ä¿¡æ¯morgan

```shell
npm i morgan
```

```js
const express = require('express')
const morgan = require('morgan') //ç¬¬ä¸‰æ–¹æ¨¡å—
const fs = require('fs')

const app = express()

const writerStream = fs.createWriteStream('./logs/access.log', {
  //æ¯æ¬¡æ—¥å¿—ä¿¡æ¯éƒ½ä¼šä¿å­˜åˆ°è¿™é‡Œ
  flags: 'a+', //æ—¥å¿—ä¿¡æ¯è¿½åŠ 
})
//æ™®é€šä¸­é—´ä»¶ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šæ‰“å°æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨è¿ç»­ä¸­é—´ä»¶æ‰“å°æŸä¸ªè¯·æ±‚çš„ä¿¡æ¯
app.use(morgan('combined', { stream: writerStream }))

app.get('/', (req, res, next) => {
  res.end('ä¿å­˜æ—¥å¿—ä¿¡æ¯')
})

app.listen(4000, () => {
  console.log('4000')
})

```

### å®¢æˆ·ç«¯å‘é€è¯·æ±‚çš„æ–¹å¼

![image-20220411205126994](index.assets/image-20220411205126994.png) 

```js
const express = require('express')
const app = express()

//params
app.get('/products/:id/:name', (req, res, next) => {
  console.log(req.params) //paramså¯¹è±¡  { id: '001', name: 'wangyang' }
  res.end('paramså‚æ•°~')
})

//query
app.get('/login', (req, res, next) => {
  console.log(req.query) //queryå¯¹è±¡  { username: 'wangyang', password: '121654' }
  res.end('ç”¨æˆ·ç™»é™†æˆåŠŸ~')
})

app.listen(4000, () => {
  console.log('4000ç«¯å£å·²å¯åŠ¨')
})
```

### [request](https://www.expressjs.com.cn/5x/api.html#req.body)è¯·æ±‚å¯¹è±¡

![image-20220411210542629](index.assets/image-20220411210542629.png) 

### [response](https://www.expressjs.com.cn/5x/api.html#res)å¯¹è±¡

`res.json()`

```js
const express = require('express')
const app = express()

app.get('/', (req, res, next) => {
    res.status(200) //è®¾ç½®å“åº”çŠ¶æ€ç 
  //å“åº”ç»“æœä¸ºstringç±»å‹
  //   res.end('hello~')

  //å“åº”ç»“æœä¸ºjsonç±»å‹
  //æ–¹å¼ä¸€ï¼šè®¾ç½®type
  //   res.type('application/json')
  //   res.end(JSON.stringify({ name: 'aaa', age: '18' }))

  // æ–¹å¼äºŒï¼šexpressä¸­å“åº”ç»“æœä¸ºå¯¹è±¡æ—¶ï¼šå¯ä»¥ä½¿ç”¨.jsonæ–¹å¼ï¼Œè¿™ç§æ–¹å¼å¼€å‘æ—¶ç”¨çš„å¤š
  res.json({ name: 'hahah', age: 18 }) //ä¼šç›´æ¥æŠŠå¯¹è±¡è½¬åŒ–ä¸ºjson
  //   res.json(['name', 'age']) //æ•°ç»„ã€å­—ç¬¦ä¸²...éƒ½æ²¡æœ‰é—®é¢˜
})

app.listen(4000, () => {
  console.log('4000ç«¯å£å·²å¯åŠ¨')
})
```

![image-20220411211956129](index.assets/image-20220411211956129.png) 

### expressè·¯ç”±

![image-20220411212408075](index.assets/image-20220411212408075.png) 

åŸºæœ¬ä½¿ç”¨

![image-20220411214600651](index.assets/image-20220411214600651.png) 

### é™æ€èµ„æºæœåŠ¡å™¨

```js
const express = require('express')
const app = express()

app.use(express.static('./dist'))

//æœ¬åœ°ip
app.listen(3000, '192.168.31.172', () => {
    console.log('3000ç«¯å£å·²å¯åŠ¨');
})
```

### expressé”™è¯¯å¤„ç†

```js
const express = require('express')
const app = express()

app.get('/login', (req, res, next) => {
  const isLogin = false //æ¨¡æ‹Ÿé”™è¯¯
  if (isLogin) {
    res.json('login message~')
  } else {
    next(new Error('USERS_NAME_DOES_NOT_EXISTS')) //nextå‡½æ•°ä¸­æŠ›å‡ºé”™è¯¯å¹¶å¸¦ä¸Šå‚æ•°ï¼Œè¿™æ ·å°±ä¼šæ‰§è¡Œä¸‹é¢çš„å››ä¸ªå‚æ•°çš„ä¸“é—¨æ‰§è¡Œé”™è¯¯çš„ä¸­é—´ä»¶
  }
})

app.get('/register', (req, res, next) => {
  const isRegister = true
  if (!isRegister) {
    res.json('register success~')
  } else {
    next(new Error('USERS_NAME_ALREADY_EXISTS'))
  }
})

//æ‰§è¡Œé”™è¯¯çš„ä¸­é—´ä»¶ï¼ˆå½“å‚æ•°ä¸ºå››ä¸ªçš„æ—¶å€™ï¼Œæ‰§è¡Œé”™è¯¯ï¼‰â­
app.use((err, req, res, next) => {
  let status = 400
  let errMessage = ''

  switch (err.message) {
    case 'USERS_NAME_DOES_NOT_EXISTS':
      status = 400
      errMessage = 'users name does not exists'
      break
    case 'USERS_NAME_ALREADY_EXISTS':
      status = 401
      errMessage = 'users name already exists'
      break
    default:
      status = 404
      errMessage = 'NOT FOUND~'
  }
  res.status(status)
  res.json({
    errCode: status,
    errMessage: errMessage,
  })
})
app.listen(4000, () => {
  console.log('4000ç«¯å£å·²å¯åŠ¨')
})
```

## koa

![image-20220412152516862](index.assets/image-20220412152516862.png) 

### åˆå§‹åŒ–

ä¸­é—´ä»¶æ‰§è¡Œå®Œäº†ä¾ç„¶æ²¡æœ‰`res.end()`è¿”å›ç»“æœå°±ä¼šè¿”å›`not found`â­

```shell
npm init -y
npm i koa
```

```js
const Koa = require("koa") //è¿”å›çš„æ˜¯ä¸€ä¸ªç±»Application
const app = new Koa()

app.use((ctx, next) => {
  console.log(ctx.response)
  console.log(ctx.request)
  //ctxä¸Šä¸‹æ–‡å¯¹è±¡
  ctx.response.body = "hello world" //ç›¸å½“äºåŸç”Ÿçš„res.end('hello world')
  // ctx.body = 'Hello World';
})
app.listen(4000, () => {
  console.log("koa4000ç«¯å£å·²å¯åŠ¨")
})
```

### ä¸­é—´ä»¶æ³¨å†Œ

ä¸expressä¸åŒï¼Œkoa`æ²¡æœ‰`ä»¥ä¸‹ä¸‰ç§æ–¹å¼â­

* 1ã€æ²¡æœ‰methodsæ–¹å¼ï¼š

â€‹		app.get()æˆ–è€…app.post()...

* 2ã€æ²¡æœ‰pathæ–¹å¼:

â€‹		app.use('/home',()=>{})

* 3ã€æ²¡æœ‰è¿ç»­æ³¨å†Œæ–¹å¼ï¼š

â€‹		app.use('/home',(req,res)=>{},(req,res)=>{},(req,res)=>{},)

```js
//é€šè¿‡è¿™ç§æ–¹å¼
app.use((ctx, next) => {
  //åªèƒ½æ‰‹åŠ¨åˆ¤æ–­pathå’Œmethod
  if (ctx.request.url === "/home") {
    if (ctx.request.method === "GET") {
      console.log("haha")
      ctx.response.body = "hello world"
    }
  }
  //koaé‡Œé¢ï¼Œå“åº”ä¸¤æ¬¡ä¸ä¼šæŠ¥é”™
  ctx.response.body = "hello world"
})
//æƒ³è¦è¿ç»­æ³¨å†Œå°±åªèƒ½å¤šå†™å‡ ä¸ªapp.use()
app.listen(3000, () => {
  console.log("koa3000ç«¯å£å·²å¯åŠ¨")
})
```

### koaè·¯ç”±

`koa-router`: ç¤¾åŒºæä¾›çš„ç¬¬ä¸‰æ–¹è·¯ç”±æ’ä»¶

```shell
npm i koa-router
```

koaè·¯ç”±ä¸­å¯ä»¥ä½¿ç”¨pathåŒ¹é…æ–¹å¼ã€methodåŒ¹é…æ–¹å¼ã€è¿ç»­æ³¨å†Œæ–¹å¼â­

![image-20220413093959206](index.assets/image-20220413093959206.png) 

### requestå‚æ•°è§£æ

#### paramsã€query

```js
const Koa = require("koa")
const app = new Koa()

const Router = require("koa-router")
const userRrouter = new Router({ prefix: "/user" })

userRrouter.get("/:id", (ctx, next) => {
  //user/1321?username=wangyang&password=11561
  console.log(ctx.request.query) //{ username: 'wangyang', password: '11561' }
  console.log(ctx.request.params) //{ id: '1321' }
  ctx.response.body = "hahhahhahha"
})

app.use(userRrouter.routes())

// app.use((ctx, next) => {
//     console.log(ctx.request.url); // /1321?username=wangyang&password=11561
//     console.log(ctx.request.path); // /1321
//     console.log(ctx.request.query); //{ username: 'wangyang', password: '11561' }
//     console.log(ctx.request.params); //undefined è¿™æ ·æ‹¿ä¸åˆ°ï¼Œæƒ³è¦æ‹¿åˆ°éœ€æ‰‹åŠ¨è§£æctx.request.url,è¦ä½¿ç”¨è·¯ç”±æ‰èƒ½æ‹¿åˆ°
//     ctx.response.body = 'hello world'
// })

app.listen(4000, () => {
  console.log("koa4000ç«¯å£å·²å¯åŠ¨")
})
```

#### jsonã€x-www-form-urlencoded

`json`ã€`x-www-form-urlencoded`ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“`koa-bodyparser`

ä»`ctx.request.body`ä¸­è·å–æ•°æ®

`form-data`ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“`koa-multer`

ä»`ctx.req.body`ä¸­è·å–æ•°æ®â­

> koa-multeråº“è·å–ä¿¡æ¯éƒ½æ˜¯åœ¨`req`å¯¹è±¡é‡Œé¢

```shell
npm i koa-bodyparser
npm i koa-multer
```

```js
const Koa = require("koa")
const app = new Koa()

const bodyParser = require("koa-bodyparser")
app.use(bodyParser()) //å¯¼å…¥koa-bodyparserå¹¶ä½¿ç”¨

const multer = require("koa-multer")
const upload = multer()

app.use(upload.any()) //å¯¼å…¥koa-multeræ³¨å†Œå¹¶ä½¿ç”¨

app.use((ctx, next) => {
  console.log(ctx.request.body) //jsonå’Œurlencodedæ ¼å¼

  console.log(ctx.req.body) //form-dataæ ¼å¼è·å–æ˜¯é€šè¿‡reqå¯¹è±¡â­
  ctx.response.body = "hahhahhahha"
})

app.listen(4000, () => {
  console.log("koa4000ç«¯å£å·²å¯åŠ¨")
})
```

> å°½é‡ä¸è¦ä½¿ç”¨å…¨å±€ä¸­é—´ä»¶`upload.any()`ï¼Œéœ€è¦æ—¶åœ¨å•ç‹¬è¯·æ±‚ä¸­ä½¿ç”¨è¿ç»­æ³¨å†Œä¸­é—´ä»¶

#### form-dataæ–‡ä»¶ä¸Šä¼ è§£æ

ä½¿ç”¨`koa-multer`

```js
const Koa = require("koa")
const multer = require("koa-multer")
const Router = require("koa-router")
const path = require("path")

const app = new Koa()
const uploadRouter = new Router({ prefix: "/upload" })

const storage = multer.diskStorage({
  //æ–‡ä»¶ä¿å­˜ä½ç½®
  destination: (req, file, cb) => {
    cb(null, "./uploads/") //cbæ˜¯å›è°ƒå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯ä¿¡æ¯
  },
  //å®šä¹‰ä¸Šä¼ çš„æ–‡ä»¶åå­—
  filename: (req, file, cb) => {
    cb(null, Date.now() + path.extname(file.originalname))
  },
})
const upload = multer({
  // dest:'./uploads',
  storage,
})
uploadRouter.post("/avatar", upload.array("file"), (ctx, next) => {
  console.log(ctx.req.file) //ä¸Šä¼ å•ä¸ªæ–‡ä»¶å¯ä»¥ç›´æ¥ç”¨fileæ‹¿åˆ°
  console.log(ctx.req.files) //multeråº“ä¿¡æ¯éƒ½æ”¾åœ¨reqå¯¹è±¡é‡Œé¢
  ctx.response.body = "å›¾ç‰‡ä¸Šä¼ æˆåŠŸ"
})
app.use(uploadRouter.routes())

app.listen(4000, () => {
  console.log("koa4000ç«¯å£å·²å¯åŠ¨")
})

```

### responseå“åº”

![image-20220413143116072](index.assets/image-20220413143116072.png) 

```js
const Koa = require("koa")
const app = new Koa()

app.use((ctx, next) => {
  //å“åº”çŠ¶æ€ç 
  // ctx.response.status = 404
  //å“åº”æ•°æ®
  // ctx.response.body='haha'

  // ctx.response.body = {
  //     name: 'haha',
  //     age: 15
  // }

  // ctx.response.body = ['age', 'name']

  ctx.status = 404
  ctx.body = "haha" //å®é™…ä¸Šå°±æ˜¯åœ¨æ‰§è¡Œctx.response.bodyâ­
})

app.listen(4000, () => {
  console.log("koa4000ç«¯å£å·²å¯åŠ¨")
})
```

### é™æ€èµ„æºæœåŠ¡å™¨

ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“`koa-static`

```shell
npm i koa-static
```

```js
const Koa = require("koa")
const app = new Koa()

const koaStatic = require("koa-static")
app.use(koaStatic("./dist"))

app.listen(3000, "192.168.0.108", () => {
  console.log("koa3000ç«¯å£å·²å¯åŠ¨")
})
```

### koaé”™è¯¯å¤„ç†

koaä¸­é”™è¯¯å¤„ç†ä½¿ç”¨`äº‹ä»¶å‘å‡º`ä¸`äº‹ä»¶æ¥å—`çš„å½¢å¼

```js
const Koa = require("koa")
const app = new Koa()

app.use((ctx, next) => {
  const isLogin = false
  if (!isLogin) {
    // ctxé‡Œé¢å­˜åœ¨appå¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨â­
    ctx.app.emit("error", new Error("æ‚¨è¿˜æ²¡æœ‰ç™»å½•~"), ctx)
    // ctx.app.emit('error', new Error('æ‚¨è¿˜æ²¡æœ‰ç™»å½•~'), ctx)
  }
})
app.on("error", (err, ctx) => {
  //æ ¹æ®é”™è¯¯ä¿¡æ¯åšç›¸åº”çš„é€»è¾‘åˆ¤æ–­
  ctx.status = 401
  ctx.body = err.message //é”™è¯¯ä¿¡æ¯
})

app.listen(3000, () => {
  console.log("koa3000ç«¯å£å·²å¯åŠ¨")
})
```

## expresså’Œkoaå¯¹æ¯”

![image-20220414154804280](index.assets/image-20220414154804280.png) 

![image-20220414155014041](index.assets/image-20220414155014041.png) 

expresså’Œkoaä¸­é—´ä»¶éƒ½æ˜¯æ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ‰§è¡Œnext()ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè€Œä¸æ˜¯æ‰§è¡Œä¸‹é¢çš„ä»£ç 

express

```js
const express = require("express")
const app = express()
const axios = require("axios")
const middleware1 = (req, res, next) => {
  req.message = "aa"
  next()
  res.end(req.message)
}
const middleware2 = (req, res, next) => {
  req.message += "bb"
  next()
}
const middleware3 = (req, res, next) => {
  // req.message += 'cc' //ccæ˜¯åŒæ­¥æ•°æ®ï¼Œå¯ä»¥æ‹¿åˆ°aabbcc

  //è¿™æ—¶å€™åœ¨ç¬¬ä¸€ä¸ªmiddlewareä¸­å°±å¾—ä¸åˆ°æ•°æ®ï¼Œåªèƒ½å¾—åˆ°aabbï¼Œå½“ç„¶ä½ å¯ä»¥å°†è¯¥å¼‚æ­¥è¯·æ±‚å°è£…æˆå‡½æ•°ä½¿ç”¨asyncï¼Œä½†æ˜¯åœ¨ä¸­é—´ä»¶ä¸­å¤„ç†æ˜¾çš„ä¹åŠ›
  axios.get("http://152.136.185.210:8000/api/w6/recommend").then((data) => {
    req.message += data.data.data.context.currentTime
  })
}

app.use(middleware1, middleware2, middleware3)
app.listen(3000, () => {
  console.log("3000ç«¯å£å·²å¯åŠ¨")
})
```

> `express ä¸­next()è¿”å›çš„ä¸æ˜¯promiseå¯¹è±¡`ï¼Œexpressæ¡†æ¶åœ¨å¤„ç†å¼‚æ­¥çš„æ—¶å€™å°±æœ‰ç‚¹ä¹åŠ›

koa

```js
const Koa = require("koa")
const app = new Koa()
const axios = require("axios")
const middleware1 = async (ctx, next) => {
  ctx.message = "aa"
  await next()
  ctx.body = ctx.message // aabb1540114164
}
const middleware2 = async (ctx, next) => {
  ctx.message += "bb"
  await next()
}
const middleware3 = async (ctx, next) => {
  const data = await axios.get("http://152.136.185.210:8000/api/w6/recommend")
  ctx.message += data.data.data.context.currentTime
}
app.use(middleware1)
app.use(middleware2)
app.use(middleware3)

app.listen(3000, () => {
  console.log("3000ç«¯å£å·²å¯åŠ¨")
})
```

> `koaä¸­next()å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªpromise`
>
> koaä¸­åŒæ­¥æ•°æ®å’Œexpressä¸€æ ·èƒ½è¾¾åˆ°éœ€æ±‚
>
> å¼‚æ­¥è¯·æ±‚çš„æ•°æ®ä¹Ÿå¯ä»¥é€šè¿‡`asyncå‡½æ•°`åŒæ­¥æ‰§è¡Œï¼Œå°±æ˜¯å› ä¸ºnextå‡½æ•°è¿”å›çš„æ˜¯peomiseï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨await
>
> expressä¸­ä½¿ç”¨awaitæ˜¯æ— æ•ˆçš„

 ![image-20220414163105804](index.assets/image-20220414163105804.png) 

dispatchå°±æ˜¯nextå‡½æ•°ï¼Œåªæ˜¯ä¹ æƒ¯å†™æˆnext

## MySQL











